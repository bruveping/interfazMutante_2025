<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ PRO STATION V4 // QUEUE & GAIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-blue: #06b6d4;
            --neon-pink: #f43f5e;
            --bg-dark: #0f1115;
            --panel-bg: #111827;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e5e7eb;
            overflow: hidden;
            user-select: none;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }

        /* General Range Reset */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }

        /* --- VERTICAL SLIDERS (STRICT) --- */
        /* Usamos transform para asegurar verticalidad en todos los navegadores si slider-vertical falla */
        .slider-vertical-wrapper {
            position: relative;
            height: 127px; /* REQUERIMIENTO: 127px */
            width: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .slider-vertical {
            width: 127px; /* El ancho ser√° la altura al rotar */
            height: 20px;
            transform: rotate(-90deg);
            transform-origin: center;
            background: transparent;
            cursor: pointer;
            position: absolute;
        }

        /* Estilo del track del slider (visual) */
        .slider-track-bg {
            position: absolute;
            width: 4px;
            height: 100%;
            background: #1f2937;
            border-radius: 2px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* Thumb Styles para los sliders rotados */
        .slider-vertical::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #d1d5db;
            border: 2px solid #000;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        /* Volume Fader Specifics (Rectangular thumb) */
        .vol-fader::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px; /* Ancho visual al estar rotado */
            width: 30px;  /* Altura visual al estar rotado */
            border-radius: 2px;
            background: #fff;
            border: 1px solid #000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }

        /* Crossfader Styling */
        #crossfader {
            -webkit-appearance: none;
            width: 100%;
            height: 40px;
            background: #111827;
            border-radius: 4px;
            border: 2px solid #374151;
            position: relative;
            z-index: 10;
        }
        #crossfader::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 50px;
            height: 36px;
            background: linear-gradient(180deg, #4b5563 0%, #1f2937 100%);
            border: 1px solid #6b7280;
            border-radius: 2px;
            cursor: col-resize;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .deck-active-a { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(6, 182, 212, 0.1); }
        .deck-active-b { border-color: var(--neon-pink); box-shadow: 0 0 15px rgba(244, 63, 94, 0.1); }

        .btn-loop {
            font-size: 10px;
            padding: 4px 0;
            background: #374151;
            color: #9ca3af;
            border-radius: 3px;
            font-weight: 600;
            border: 1px solid #4b5563;
        }
        .btn-loop:hover { background: #4b5563; color: white; border-color: #6b7280; }
        
        canvas { display: block; width: 100%; height: 100%; }

        /* Queue List Styling */
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: #1f2937;
            border-bottom: 1px solid #374151;
            font-size: 11px;
            color: #d1d5db;
        }
        .queue-item:hover { background: #374151; }
        .queue-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="h-screen flex flex-col bg-black">

    <!-- Header: Master Vol & Info -->
    <header class="h-12 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 shrink-0 z-30 shadow-md">
        <div class="flex items-center gap-3">
            <span class="text-2xl">üéõÔ∏è</span>
            <div>
                <h1 class="font-bold text-gray-200 tracking-wider text-sm leading-none">DJ STATION <span class="text-cyan-500 text-[10px] align-top">V4</span></h1>
                <span class="text-[9px] text-gray-500 font-mono">MULTI-TRACK // GAIN-LINKED WAVEFORMS</span>
            </div>
        </div>
        
        <!-- MASTER VOLUME -->
        <div class="flex items-center gap-3 bg-gray-800 px-3 py-1 rounded border border-gray-700">
            <span class="text-[10px] font-bold text-yellow-500">MASTER</span>
            <input type="range" id="master-vol" class="w-32 h-2 bg-gray-600 rounded-full accent-yellow-500" min="0" max="1" step="0.01" value="0.8" oninput="updateMasterVolume(this.value)">
            <span id="master-val" class="text-[10px] mono text-yellow-200 w-8">80%</span>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- DECK A (LEFT) -->
        <div id="deck-a" class="flex-1 flex flex-col bg-gray-900/50 border-r border-gray-800 relative transition-all duration-200 border border-transparent">
            <!-- Header A -->
            <div class="p-2 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                <div class="flex items-center gap-2 overflow-hidden">
                    <div class="w-6 h-6 bg-cyan-900 rounded flex items-center justify-center font-bold text-cyan-400 border border-cyan-700 text-xs shadow-[0_0_10px_rgba(6,182,212,0.3)]">A</div>
                    <div id="title-a" class="text-xs font-mono text-cyan-100 truncate max-w-[200px]">No Track Loaded</div>
                </div>
                <div class="text-[10px] text-cyan-500 font-bold" id="bpm-a">-- BPM</div>
            </div>

            <!-- Visualizer A -->
            <div id="wave-container-a" class="h-48 bg-black relative w-full group border-b border-gray-800 touch-none overflow-hidden">
                <canvas id="canvas-a"></canvas>
                <!-- Playhead -->
                <div id="cursor-a" class="absolute top-0 bottom-0 w-0.5 bg-cyan-400 pointer-events-none z-20 shadow-[0_0_10px_#06b6d4]" style="left: 0%"></div>
                <div class="absolute bottom-2 left-2 font-mono text-xl text-cyan-500 bg-black/60 px-2 rounded backdrop-blur-sm pointer-events-none" id="time-a">00:00</div>
                <!-- Gain Indicator on Waveform -->
                <div id="gain-indicator-a" class="absolute top-2 right-2 text-[10px] text-cyan-700 font-mono pointer-events-none transition-colors">GAIN x1.0</div>
            </div>

            <!-- Controls A -->
            <div class="flex-1 p-4 flex flex-col gap-4 overflow-y-auto bg-gradient-to-b from-gray-900 to-black">
                <div class="flex flex-wrap gap-4 justify-center md:justify-start items-start">
                    <!-- Play/Cue -->
                    <div class="flex flex-col gap-2">
                        <button onclick="deckA.togglePlay()" id="btn-play-a" class="w-20 h-20 rounded-full bg-gray-800 border-2 border-cyan-600 hover:bg-cyan-900 hover:border-cyan-400 text-cyan-400 flex items-center justify-center shadow-[0_0_20px_rgba(6,182,212,0.15)] transition active:scale-95 active:shadow-[0_0_30px_rgba(6,182,212,0.4)]">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button onclick="deckA.stop()" class="w-20 h-8 rounded bg-gray-800 hover:bg-red-900/40 text-gray-400 border border-gray-700 text-xs font-bold">CUE</button>
                    </div>

                    <!-- Loop Grid -->
                    <div class="bg-gray-800/50 p-3 rounded border border-gray-700 flex flex-col gap-2 shadow-lg backdrop-blur-sm">
                        <div class="text-[9px] font-bold text-cyan-600 uppercase tracking-widest mb-1 border-b border-gray-700 pb-1">Loop Control</div>
                        <div class="flex gap-1 mb-1">
                            <button onclick="deckA.setLoopIn()" class="flex-1 h-6 bg-cyan-900/30 text-cyan-400 border border-cyan-800 text-[10px] rounded hover:bg-cyan-800">IN</button>
                            <button onclick="deckA.setLoopOut()" class="flex-1 h-6 bg-cyan-900/30 text-cyan-400 border border-cyan-800 text-[10px] rounded hover:bg-cyan-800">OUT</button>
                            <button onclick="deckA.exitLoop()" class="flex-1 h-6 bg-gray-700 text-gray-300 border border-gray-600 text-[10px] rounded hover:bg-gray-600">EXIT</button>
                        </div>
                        <div class="grid grid-cols-4 gap-1 w-40">
                            <button class="btn-loop text-cyan-200" onclick="deckA.setLoopFraction(2)">1/2</button>
                            <button class="btn-loop text-cyan-200" onclick="deckA.setLoopFraction(4)">1/4</button>
                            <button class="btn-loop text-cyan-200" onclick="deckA.setLoopFraction(8)">1/8</button>
                            <button class="btn-loop text-cyan-200" onclick="deckA.setLoopFraction(16)">1/16</button>
                        </div>
                    </div>
                </div>
                
                <!-- Pitch Fader -->
                <div class="mt-auto pt-2">
                    <div class="flex justify-between text-[9px] text-gray-500 font-mono mb-1">
                        <span>-10%</span>
                        <span id="pitch-val-a" class="text-cyan-400">0.0%</span>
                        <span>+10%</span>
                    </div>
                    <input type="range" class="w-full h-4 bg-gray-800 rounded appearance-none border border-gray-700 cursor-ew-resize" min="-1000" max="1000" value="0" oninput="deckA.setDetune(this.value)" ondblclick="this.value=0; deckA.setDetune(0)">
                    <div class="w-0.5 h-2 bg-cyan-500 mx-auto mt-1"></div>
                </div>
            </div>
        </div>

        <!-- MIXER SECTION (CENTER) -->
        <div class="w-48 bg-[#15181e] border-l border-r border-gray-800 flex flex-col shrink-0 z-20 shadow-2xl relative">
            <div class="text-[10px] font-bold text-gray-500 tracking-[0.3em] text-center w-full py-2 bg-gray-900 border-b border-gray-800">MIXER</div>

            <div class="flex-1 flex px-2 py-4 justify-between">
                
                <!-- CHANNEL A STRIP -->
                <div class="flex flex-col items-center gap-2 flex-1 border-r border-gray-800/50 pr-1">
                    <!-- GAIN A (x3) -->
                    <div class="flex flex-col items-center mb-2">
                         <span class="text-[9px] text-gray-400 mb-1">VOL A</span>
                         <div class="slider-vertical-wrapper">
                             <div class="slider-track-bg w-[6px] bg-gray-800"></div>
                             <!-- Max value 3 for 300% amplification -->
                             <input type="range" class="slider-vertical vol-fader" min="0" max="3" step="0.01" value="1" 
                                    oninput="deckA.setGain(this.value)" ondblclick="this.value=1; deckA.setGain(1)">
                         </div>
                         <span id="gain-val-a" class="text-[9px] font-mono text-cyan-500 mt-2">1.0</span>
                    </div>

                    <!-- EQs A -->
                    <div class="flex gap-1">
                         <!-- HI -->
                         <div class="flex flex-col items-center">
                             <div class="slider-vertical-wrapper" style="height: 80px;">
                                 <div class="slider-track-bg"></div>
                                 <input type="range" class="slider-vertical" style="width: 80px;" min="-20" max="10" value="0" oninput="deckA.setEQ('high', this.value)">
                             </div>
                             <span class="text-[8px] text-gray-500 mt-1">HI</span>
                         </div>
                         <!-- LO -->
                         <div class="flex flex-col items-center">
                             <div class="slider-vertical-wrapper" style="height: 80px;">
                                 <div class="slider-track-bg"></div>
                                 <input type="range" class="slider-vertical" style="width: 80px;" min="-20" max="10" value="0" oninput="deckA.setEQ('low', this.value)">
                             </div>
                             <span class="text-[8px] text-gray-500 mt-1">LO</span>
                         </div>
                    </div>
                </div>

                <!-- CHANNEL B STRIP -->
                <div class="flex flex-col items-center gap-2 flex-1 pl-1">
                    <!-- GAIN B (x3) -->
                    <div class="flex flex-col items-center mb-2">
                         <span class="text-[9px] text-gray-400 mb-1">VOL B</span>
                         <div class="slider-vertical-wrapper">
                             <div class="slider-track-bg w-[6px] bg-gray-800"></div>
                             <input type="range" class="slider-vertical vol-fader" min="0" max="3" step="0.01" value="1" 
                                    oninput="deckB.setGain(this.value)" ondblclick="this.value=1; deckB.setGain(1)">
                         </div>
                         <span id="gain-val-b" class="text-[9px] font-mono text-rose-500 mt-2">1.0</span>
                    </div>

                    <!-- EQs B -->
                    <div class="flex gap-1">
                         <!-- HI -->
                         <div class="flex flex-col items-center">
                             <div class="slider-vertical-wrapper" style="height: 80px;">
                                 <div class="slider-track-bg"></div>
                                 <input type="range" class="slider-vertical" style="width: 80px;" min="-20" max="10" value="0" oninput="deckB.setEQ('high', this.value)">
                             </div>
                             <span class="text-[8px] text-gray-500 mt-1">HI</span>
                         </div>
                         <!-- LO -->
                         <div class="flex flex-col items-center">
                             <div class="slider-vertical-wrapper" style="height: 80px;">
                                 <div class="slider-track-bg"></div>
                                 <input type="range" class="slider-vertical" style="width: 80px;" min="-20" max="10" value="0" oninput="deckB.setEQ('low', this.value)">
                             </div>
                             <span class="text-[8px] text-gray-500 mt-1">LO</span>
                         </div>
                    </div>
                </div>

            </div>

            <!-- EQs GENERALES (Requerimiento 1: 127px) -->
            <!-- Colocados en el centro o abajo para cumplir el pedido especifico -->
            <div class="w-full bg-black border-t border-gray-800 p-2 flex justify-center gap-4">
                <div class="flex flex-col items-center">
                     <span class="text-[9px] text-gray-500 mb-1">FILTER A</span>
                     <div class="slider-vertical-wrapper"> <!-- 127px set in CSS -->
                         <div class="slider-track-bg bg-cyan-900/30"></div>
                         <input type="range" class="slider-vertical" min="0" max="100" value="50" oninput="deckA.setFilter(this.value)" ondblclick="this.value=50; deckA.setFilter(50)">
                     </div>
                </div>
                <div class="flex flex-col items-center">
                     <span class="text-[9px] text-gray-500 mb-1">FILTER B</span>
                     <div class="slider-vertical-wrapper"> <!-- 127px set in CSS -->
                         <div class="slider-track-bg bg-rose-900/30"></div>
                         <input type="range" class="slider-vertical" min="0" max="100" value="50" oninput="deckB.setFilter(this.value)" ondblclick="this.value=50; deckB.setFilter(50)">
                     </div>
                </div>
            </div>
        </div>

        <!-- DECK B (RIGHT) -->
        <div id="deck-b" class="flex-1 flex flex-col bg-gray-900/50 border-l border-gray-800 relative transition-all duration-200 border border-transparent">
             <!-- Header B -->
             <div class="p-2 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                <div class="flex items-center gap-2 overflow-hidden">
                    <div class="w-6 h-6 bg-rose-900 rounded flex items-center justify-center font-bold text-rose-400 border border-rose-700 text-xs shadow-[0_0_10px_rgba(244,63,94,0.3)]">B</div>
                    <div id="title-b" class="text-xs font-mono text-rose-100 truncate max-w-[200px]">No Track Loaded</div>
                </div>
                <div class="text-[10px] text-rose-500 font-bold" id="bpm-b">-- BPM</div>
            </div>

            <!-- Visualizer B -->
            <div id="wave-container-b" class="h-48 bg-black relative w-full group border-b border-gray-800 touch-none overflow-hidden">
                <canvas id="canvas-b"></canvas>
                <!-- Playhead -->
                <div id="cursor-b" class="absolute top-0 bottom-0 w-0.5 bg-rose-400 pointer-events-none z-20 shadow-[0_0_10px_#f43f5e]" style="left: 0%"></div>
                <div class="absolute bottom-2 right-2 font-mono text-xl text-rose-500 bg-black/60 px-2 rounded backdrop-blur-sm pointer-events-none" id="time-b">00:00</div>
                 <!-- Gain Indicator -->
                 <div id="gain-indicator-b" class="absolute top-2 left-2 text-[10px] text-rose-700 font-mono pointer-events-none transition-colors">GAIN x1.0</div>
            </div>

            <!-- Controls B -->
            <div class="flex-1 p-4 flex flex-col gap-4 overflow-y-auto bg-gradient-to-b from-gray-900 to-black">
                <div class="flex flex-wrap gap-4 justify-center md:justify-end items-start">
                     <!-- Loop Grid -->
                     <div class="bg-gray-800/50 p-3 rounded border border-gray-700 flex flex-col gap-2 shadow-lg backdrop-blur-sm order-2 md:order-1">
                        <div class="text-[9px] font-bold text-rose-600 uppercase tracking-widest mb-1 border-b border-gray-700 pb-1">Loop Control</div>
                        <div class="flex gap-1 mb-1">
                            <button onclick="deckB.setLoopIn()" class="flex-1 h-6 bg-rose-900/30 text-rose-400 border border-rose-800 text-[10px] rounded hover:bg-rose-800">IN</button>
                            <button onclick="deckB.setLoopOut()" class="flex-1 h-6 bg-rose-900/30 text-rose-400 border border-rose-800 text-[10px] rounded hover:bg-rose-800">OUT</button>
                            <button onclick="deckB.exitLoop()" class="flex-1 h-6 bg-gray-700 text-gray-300 border border-gray-600 text-[10px] rounded hover:bg-gray-600">EXIT</button>
                        </div>
                        <div class="grid grid-cols-4 gap-1 w-40">
                            <button class="btn-loop text-rose-200" onclick="deckB.setLoopFraction(2)">1/2</button>
                            <button class="btn-loop text-rose-200" onclick="deckB.setLoopFraction(4)">1/4</button>
                            <button class="btn-loop text-rose-200" onclick="deckB.setLoopFraction(8)">1/8</button>
                            <button class="btn-loop text-rose-200" onclick="deckB.setLoopFraction(16)">1/16</button>
                        </div>
                    </div>

                    <!-- Play/Cue -->
                    <div class="flex flex-col gap-2 order-1 md:order-2">
                        <button onclick="deckB.togglePlay()" id="btn-play-b" class="w-20 h-20 rounded-full bg-gray-800 border-2 border-rose-600 hover:bg-rose-900 hover:border-rose-400 text-rose-400 flex items-center justify-center shadow-[0_0_20px_rgba(244,63,94,0.15)] transition active:scale-95 active:shadow-[0_0_30px_rgba(244,63,94,0.4)]">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button onclick="deckB.stop()" class="w-20 h-8 rounded bg-gray-800 hover:bg-red-900/40 text-gray-400 border border-gray-700 text-xs font-bold">CUE</button>
                    </div>
                </div>

                <!-- Pitch Fader -->
                <div class="mt-auto pt-2">
                    <div class="flex justify-between text-[9px] text-gray-500 font-mono mb-1">
                        <span>-10%</span>
                        <span id="pitch-val-b" class="text-rose-400">0.0%</span>
                        <span>+10%</span>
                    </div>
                    <input type="range" class="w-full h-4 bg-gray-800 rounded appearance-none border border-gray-700 cursor-ew-resize" min="-1000" max="1000" value="0" oninput="deckB.setDetune(this.value)" ondblclick="this.value=0; deckB.setDetune(0)">
                    <div class="w-0.5 h-2 bg-rose-500 mx-auto mt-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- LIBRARY / QUEUE DRAWER -->
    <div class="h-32 bg-gray-900 border-t border-gray-800 flex flex-col shrink-0 z-40 relative">
        <div class="flex justify-between items-center px-4 py-1 bg-gray-800 border-b border-gray-700">
            <span class="text-[10px] font-bold text-gray-400 tracking-wider">TRACK QUEUE</span>
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-3 py-1 rounded font-bold transition">
                + ADD TRACKS
                <input type="file" id="file-upload" class="hidden" accept="audio/*" multiple>
            </label>
        </div>
        <div id="queue-list" class="flex-1 overflow-y-auto">
            <!-- Items will appear here -->
            <div class="p-4 text-center text-gray-600 text-xs italic" id="empty-msg">Drag files here or click + ADD TRACKS</div>
        </div>
    </div>

    <!-- CROSSFADER SECTION -->
    <div class="h-16 bg-black border-t border-gray-800 flex items-center justify-center shrink-0 px-8 relative z-50">
        <div class="w-full max-w-4xl flex items-center gap-6">
            <div class="font-bold text-cyan-600 text-xl tracking-tighter">DECK A</div>
            <div class="flex-1 relative h-10 flex items-center">
                <input id="crossfader" type="range" min="0" max="100" value="50" oninput="updateCrossfader(this.value)" ondblclick="this.value=50; updateCrossfader(50);">
                <!-- Center Mark -->
                <div class="absolute left-1/2 top-0 bottom-0 w-px bg-white/20 pointer-events-none transform -translate-x-1/2"></div>
            </div>
            <div class="font-bold text-rose-600 text-xl tracking-tighter">DECK B</div>
        </div>
    </div>

<script>
/**
 * DJ PRO ENGINE V4
 * Supports: Multiple File Queue, Individual Gain (x3), Reactive Waveforms
 */

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let deckA, deckB;
let masterGainNode = audioCtx.createGain();
masterGainNode.connect(audioCtx.destination);
masterGainNode.gain.value = 0.8; // Default Master

// Library State
const trackLibrary = [];

class Deck {
    constructor(id, color) {
        this.id = id;
        this.color = color;
        this.buffer = null;
        this.source = null;
        
        // Audio Graph
        // Source -> EQ High -> EQ Low -> Filter -> Channel Gain -> Crossfader Gain -> Master
        this.channelGain = audioCtx.createGain(); // The per-deck slider (x3)
        this.crossfaderGain = audioCtx.createGain(); // Controlled by crossfader
        this.filterNode = audioCtx.createBiquadFilter();
        this.eqLow = audioCtx.createBiquadFilter();
        this.eqHigh = audioCtx.createBiquadFilter();
        
        // Settings
        this.filterNode.type = "allpass"; // Start neutral
        this.eqLow.type = "lowshelf";
        this.eqLow.frequency.value = 320;
        this.eqHigh.type = "highshelf";
        this.eqHigh.frequency.value = 3200;
        
        // Connections
        this.eqHigh.connect(this.eqLow);
        this.eqLow.connect(this.filterNode);
        this.filterNode.connect(this.channelGain);
        this.channelGain.connect(this.crossfaderGain);
        this.crossfaderGain.connect(masterGainNode);

        // Initial Values
        this.channelGain.gain.value = 1.0; 
        this.currentGainValue = 1.0; // Stored for visual scaling

        // Playback State
        this.isPlaying = false;
        this.startTime = 0;
        this.pausedAt = 0;
        this.detune = 0;
        this.loopStart = 0;
        this.loopEnd = 0;
        this.isLoopActive = false;
        this.originalLoopLength = 0;
        
        // UI
        this.canvas = document.getElementById(`canvas-${id}`);
        this.ctx = this.canvas.getContext('2d');
        this.cursor = document.getElementById(`cursor-${id}`);
        this.timeDisplay = document.getElementById(`time-${id}`);
        
        this.setupCanvasInteraction();
        window.addEventListener('resize', () => this.resizeCanvas());
        this.resizeCanvas();
        this.drawLoop();
    }

    setupCanvasInteraction() {
        let isDragging = false;
        const seek = (e) => {
            if(!this.buffer) return;
            const rect = this.canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
            const pct = x / rect.width;
            
            this.pausedAt = pct * this.buffer.duration;
            if (this.isPlaying) {
                this.stopSource();
                this.playSource();
            }
            this.updateUI(this.pausedAt);
        };

        this.canvas.parentElement.addEventListener('mousedown', (e) => { isDragging = true; seek(e); });
        window.addEventListener('mousemove', (e) => { if(isDragging) seek(e); });
        window.addEventListener('mouseup', () => isDragging = false);
        this.canvas.parentElement.addEventListener('touchstart', (e) => { isDragging = true; seek(e); }, {passive:false});
        this.canvas.parentElement.addEventListener('touchmove', (e) => { if(isDragging) { e.preventDefault(); seek(e); }}, {passive:false});
        this.canvas.parentElement.addEventListener('touchend', () => isDragging = false);
    }

    resizeCanvas() {
        const container = this.canvas.parentElement;
        this.canvas.width = container.clientWidth;
        this.canvas.height = container.clientHeight;
        if(this.buffer) this.drawWaveform();
    }

    async loadBuffer(buffer, name) {
        this.buffer = buffer;
        this.stop();
        document.getElementById(`title-${this.id}`).innerText = name;
        document.getElementById(`title-${this.id}`).title = name;
        this.drawWaveform();
    }

    play() {
        if (!this.buffer) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        this.isPlaying = true;
        this.playSource();
        this.updatePlayBtn();
    }

    playSource() {
        this.source = audioCtx.createBufferSource();
        this.source.buffer = this.buffer;
        this.source.detune.value = this.detune;
        this.source.loop = this.isLoopActive;
        this.source.loopStart = this.loopStart;
        this.source.loopEnd = this.loopEnd;
        
        this.source.connect(this.eqHigh);
        
        this.startTime = audioCtx.currentTime - this.pausedAt;
        this.source.start(0, this.pausedAt);
    }

    pause() {
        this.isPlaying = false;
        this.pausedAt = this.getCurrentTime();
        this.stopSource();
        this.updatePlayBtn();
    }

    stopSource() {
        if (this.source) {
            try { this.source.stop(); } catch(e){}
            this.source = null;
        }
    }

    togglePlay() {
        this.isPlaying ? this.pause() : this.play();
    }

    stop() {
        this.pause();
        this.pausedAt = 0;
        this.isLoopActive = false;
        this.updateUI(0);
    }

    getCurrentTime() {
        if (!this.isPlaying) return this.pausedAt;
        let curr = audioCtx.currentTime - this.startTime;
        if (curr >= this.buffer.duration && !this.isLoopActive) {
            this.pause();
            return this.buffer.duration;
        }
        // Loop calc
        if (this.isLoopActive && curr >= this.loopEnd) {
             const loopDur = this.loopEnd - this.loopStart;
             curr = this.loopStart + (curr - this.loopStart) % loopDur;
        }
        return curr;
    }

    // --- Audio Logic ---
    setGain(val) {
        const gain = parseFloat(val); // 0 to 3.0
        this.channelGain.gain.setTargetAtTime(gain, audioCtx.currentTime, 0.05);
        this.currentGainValue = gain; // Store for visuals
        
        // Update Label
        document.getElementById(`gain-val-${this.id}`).innerText = "x" + gain.toFixed(2);
        
        // Update Waveform Visual Indicator (text color changes based on clipping)
        const indicator = document.getElementById(`gain-indicator-${this.id}`);
        indicator.innerText = `GAIN x${gain.toFixed(2)}`;
        indicator.className = `absolute top-2 ${this.id==='a'?'right-2':'left-2'} text-[10px] font-mono pointer-events-none transition-colors ` + (gain > 1.5 ? 'text-red-500 font-bold' : (this.id==='a'?'text-cyan-700':'text-rose-700'));
        
        // Redraw waveform to reflect amplification
        if(this.buffer) requestAnimationFrame(() => this.drawWaveform());
    }

    setEQ(type, val) {
        // Simple shelf EQ
        if(type === 'low') this.eqLow.gain.value = parseFloat(val);
        if(type === 'high') this.eqHigh.gain.value = parseFloat(val);
    }
    
    setFilter(val) {
        // 0-45 = LowPass, 45-55 = Off, 55-100 = HighPass
        const v = parseInt(val);
        if (v > 45 && v < 55) {
            this.filterNode.type = "allpass";
            this.filterNode.frequency.value = 0;
        } else if (v <= 45) {
            this.filterNode.type = "lowpass";
            // Map 45->0 to 20000->50Hz
            const freq = 50 + (v/45) * 6000; 
            this.filterNode.frequency.value = freq;
            this.filterNode.Q.value = 2; 
        } else {
            this.filterNode.type = "highpass";
            // Map 55->100 to 100->10000Hz
            const freq = 100 + ((v-55)/45) * 8000; 
            this.filterNode.frequency.value = freq;
            this.filterNode.Q.value = 2; 
        }
    }

    setDetune(val) {
        this.detune = parseInt(val);
        const sign = this.detune > 0 ? '+' : '';
        const pct = (this.detune / 100).toFixed(1);
        document.getElementById(`pitch-val-${this.id}`).innerText = `${sign}${pct}%`;
        if (this.source) this.source.detune.value = this.detune;
    }

    // --- Loop Logic ---
    setLoopIn() { this.loopStart = this.getCurrentTime(); }
    setLoopOut() { 
        if(this.getCurrentTime() > this.loopStart) {
            this.loopEnd = this.getCurrentTime();
            this.originalLoopLength = this.loopEnd - this.loopStart;
            this.activateLoop();
        }
    }
    setLoopFraction(denom) {
        if(!this.originalLoopLength) return;
        this.loopEnd = this.loopStart + (this.originalLoopLength / denom);
        this.activateLoop();
    }
    activateLoop() {
        this.isLoopActive = true;
        if(this.isPlaying) { this.stopSource(); this.playSource(); }
    }
    exitLoop() {
        this.isLoopActive = false;
        if(this.isPlaying) { this.stopSource(); this.playSource(); }
    }

    // --- Visuals ---
    drawLoop() {
        if(this.isPlaying) {
            const t = this.getCurrentTime();
            this.updateUI(t);
        }
        requestAnimationFrame(() => this.drawLoop());
    }

    updateUI(time) {
        if(!this.buffer) return;
        const min = Math.floor(time/60);
        const sec = Math.floor(time%60).toString().padStart(2,'0');
        const ms = Math.floor((time%1)*100).toString().padStart(2,'0');
        this.timeDisplay.innerText = `${min}:${sec}.${ms}`;
        this.cursor.style.left = (time / this.buffer.duration * 100) + '%';
    }

    updatePlayBtn() {
        const icon = document.querySelector(`#btn-play-${this.id} svg`);
        icon.innerHTML = this.isPlaying ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' : '<path d="M8 5v14l11-7z"/>';
        const container = document.getElementById(`deck-${this.id}`);
        if(this.isPlaying) container.classList.add(`deck-active-${this.id}`);
        else container.classList.remove(`deck-active-${this.id}`);
    }

    /**
     * DYNAMIC WAVEFORM DRAWING
     * Reflects the current GAIN volume setting directly in the wave height
     */
    drawWaveform() {
        if (!this.buffer) return;
        const data = this.buffer.getChannelData(0);
        const w = this.canvas.width;
        const h = this.canvas.height;
        const step = Math.ceil(data.length / w);
        const ampBase = h / 2;
        
        // Dynamic Scaling Factor:
        // We multiply the raw data by currentGainValue to simulate visual amplification
        // We limit it slightly so x3 doesn't just fill the screen instantly with noise
        const visualGain = Math.max(0.1, this.currentGainValue); 

        this.ctx.clearRect(0, 0, w, h);
        
        // Draw center line
        this.ctx.beginPath();
        this.ctx.strokeStyle = '#374151';
        this.ctx.moveTo(0, h/2);
        this.ctx.lineTo(w, h/2);
        this.ctx.stroke();

        this.ctx.beginPath();
        this.ctx.strokeStyle = this.color;
        this.ctx.lineWidth = 1;
        
        for (let i = 0; i < w; i++) {
            let min = 1.0, max = -1.0;
            // Optimization: Downsampling logic
            for (let j = 0; j < step; j++) {
                const datum = data[(i * step) + j];
                if (datum < min) min = datum;
                if (datum > max) max = datum;
            }
            
            // Apply GAIN to the drawing coordinates
            const y1 = (1 + min * visualGain) * ampBase;
            const y2 = (1 + max * visualGain) * ampBase;

            // Clamp to canvas height to prevent drawing outside
            const clampedY1 = Math.max(0, Math.min(h, y1));
            const clampedY2 = Math.max(0, Math.min(h, y2));

            this.ctx.moveTo(i, clampedY1);
            this.ctx.lineTo(i, clampedY2);
        }
        this.ctx.stroke();
    }
}

// --- INIT ---
deckA = new Deck('a', '#22d3ee'); // Cyan
deckB = new Deck('b', '#fb7185'); // Rose

// --- QUEUE SYSTEM ---
document.getElementById('file-upload').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if(files.length > 0) {
        document.getElementById('empty-msg').style.display = 'none';
        
        for (const file of files) {
            // Decode immediately to get duration? No, lazy load to save memory. Just store file ref.
            // But we need to play it.
            const item = {
                file: file,
                name: file.name
            };
            trackLibrary.push(item);
            addToQueueUI(item, trackLibrary.length - 1);
        }
    }
});

function addToQueueUI(item, index) {
    const list = document.getElementById('queue-list');
    const div = document.createElement('div');
    div.className = 'queue-item group';
    div.innerHTML = `
        <span class="truncate w-1/2 font-mono text-gray-300">${index + 1}. ${item.name}</span>
        <div class="flex gap-2 opacity-60 group-hover:opacity-100 transition">
            <button onclick="loadToDeck('a', ${index})" class="text-[9px] bg-cyan-900 text-cyan-200 px-2 py-1 rounded hover:bg-cyan-700">LOAD A</button>
            <button onclick="loadToDeck('b', ${index})" class="text-[9px] bg-rose-900 text-rose-200 px-2 py-1 rounded hover:bg-rose-700">LOAD B</button>
        </div>
    `;
    list.appendChild(div);
}

async function loadToDeck(deckId, index) {
    const item = trackLibrary[index];
    const targetDeck = deckId === 'a' ? deckA : deckB;
    
    // Show loading state
    document.getElementById(`title-${deckId}`).innerText = "LOADING...";
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        const audioData = await audioCtx.decodeAudioData(e.target.result);
        targetDeck.loadBuffer(audioData, item.name);
    };
    reader.readAsArrayBuffer(item.file);
}

// --- GLOBAL CONTROLS ---
function updateMasterVolume(val) {
    masterGainNode.gain.value = val;
    document.getElementById('master-val').innerText = Math.round(val * 100) + '%';
}

function updateCrossfader(val) {
    const v = parseInt(val); // 0 to 100
    // Equal Power Crossfade Curve (approx)
    // Vol A = cos(p * pi/2), Vol B = sin(p * pi/2) usually
    // But linear is okay for web simple:
    const volA = Math.cos((v / 100) * (Math.PI / 2));
    const volB = Math.cos(((100 - v) / 100) * (Math.PI / 2));
    
    deckA.crossfaderGain.gain.value = volA;
    deckB.crossfaderGain.gain.value = volB;
}

// Init Crossfader
updateCrossfader(50);

// Drag and drop zone for Library
const queueDrawer = document.querySelector('.h-32');
queueDrawer.addEventListener('dragover', (e) => { e.preventDefault(); queueDrawer.classList.add('bg-gray-800'); });
queueDrawer.addEventListener('dragleave', (e) => { e.preventDefault(); queueDrawer.classList.remove('bg-gray-800'); });
queueDrawer.addEventListener('drop', (e) => {
    e.preventDefault();
    queueDrawer.classList.remove('bg-gray-800');
    if(e.dataTransfer.files.length) {
        const input = document.getElementById('file-upload');
        input.files = e.dataTransfer.files;
        // Trigger change manually
        const event = new Event('change');
        input.dispatchEvent(event);
    }
});

</script>
</body>
</html>