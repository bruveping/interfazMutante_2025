<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometría de Intervalos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', system-ui, sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
        }

        .node {
            cursor: pointer;
            stroke-width: 3px;
            transition: all 0.2s ease;
        }

        .node-active {
            filter: drop-shadow(0 0 8px currentColor);
        }

        .interval-line {
            stroke-opacity: 0.6;
            stroke-dasharray: 4;
            pointer-events: none;
        }

        .interval-label {
            font-size: 10px;
            fill: #94a3b8;
            font-weight: bold;
            pointer-events: none;
            background: rgba(2, 6, 23, 0.8);
        }

        .ui-panel {
            position: absolute;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 20px;
            z-index: 100;
        }

        #root-selector {
            top: 20px;
            left: 20px;
            width: 300px;
        }

        #audio-controls {
            top: 20px;
            right: 20px;
            width: 280px;
        }

        #info-panel {
            bottom: 20px;
            left: 20px;
            width: 300px;
        }

        .root-btn {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            border: 1px solid #334155;
        }

        .root-btn.active {
            background: #38bdf8;
            color: #020617;
            border-color: #7dd3fc;
            font-weight: bold;
        }

        input[type=range] {
            accent-color: #38bdf8;
        }

        .chord-suggestion {
            background: linear-gradient(90deg, #0ea5e9, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }
    </style>
</head>
<body>

<div id="root-selector" class="ui-panel">
    <h2 class="text-sky-400 font-bold mb-3 flex items-center gap-2 text-sm uppercase tracking-wider">
        Tónica (1)
    </h2>
    <div class="grid grid-cols-6 gap-2" id="root-btns-container"></div>
    <p class="text-slate-500 text-[10px] mt-4 leading-relaxed">
        Selecciona la raíz y activa intervalos en el círculo.
    </p>
</div>

<div id="audio-controls" class="ui-panel space-y-4">
    <h2 class="text-sky-400 font-bold text-sm uppercase tracking-wider mb-2">Controles de Audio</h2>
    
    <button id="play-chord-btn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-2 shadow-lg shadow-sky-900/20">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        Reproducir Acorde
    </button>

    <div class="space-y-1">
        <div class="flex justify-between text-[10px] text-slate-400 uppercase">
            <span>Resonancia</span>
            <span id="dur-val">2.0s</span>
        </div>
        <input type="range" id="duration-slider" min="0.5" max="5.0" step="0.1" value="2.0" class="w-full">
    </div>

    <div class="space-y-1">
        <div class="flex justify-between text-[10px] text-slate-400 uppercase">
            <span>Volumen Maestro</span>
            <span id="vol-val">50%</span>
        </div>
        <input type="range" id="volume-slider" min="0" max="100" step="1" value="50" class="w-full">
    </div>
</div>

<div id="info-panel" class="ui-panel">
    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Cifrado Sugerido</h3>
    <div id="suggested-chord" class="chord-suggestion text-3xl mb-3">...</div>
    
    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1 border-t border-slate-800 pt-2">Estructura Interna</h3>
    <div id="interval-list" class="flex flex-wrap gap-1 mb-3"></div>
    
    <div class="flex justify-between text-[10px] text-slate-500">
        <span>Intervalos internos:</span>
        <span id="int-count" class="text-sky-400 font-mono">0</span>
    </div>
</div>

<div id="canvas-container"></div>

<script>
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const INTERVAL_NAMES = [
        '1', '2m', '2M', '3m', '3M', '4J', '4+/5d', '5J', '6m', '6M', '7m', '7M'
    ];
    const COLORS = [
        '#f8fafc', '#f43f5e', '#fb923c', '#fbbf24', '#facc15', '#a855f7', 
        '#6366f1', '#3b82f6', '#06b6d4', '#14b8a6', '#10b981', '#84cc16'
    ];

    let currentRoot = 0;
    let activePitches = new Set();
    
    const width = window.innerWidth;
    const height = window.innerHeight;
    const radius = Math.min(width, height) * 0.32;
    const centerX = width / 2;
    const centerY = height / 2;

    const svg = d3.select("#canvas-container")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%");

    const mainG = svg.append("g");
    const linkG = mainG.append("g");
    const labelG = mainG.append("g");
    const nodeG = mainG.append("g");

    // Audio Setup
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);
    masterGain.gain.value = 0.5;

    function playNote(pitch, duration = 2.0) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const noteGain = audioCtx.createGain();
        const freq = 261.63 * Math.pow(2, pitch / 12);
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        osc.type = 'triangle';
        noteGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        noteGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(noteGain);
        noteGain.connect(masterGain);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    function playActiveChord() {
        if (activePitches.size === 0) return;
        const duration = parseFloat(document.getElementById('duration-slider').value);
        [...activePitches].sort((a,b)=>a-b).forEach((pitch, i) => {
            setTimeout(() => playNote(pitch, duration), i * 40);
        });
    }

    function getRelativeInterval(pitch) {
        return (pitch - currentRoot + 12) % 12;
    }

    /**
     * Motor de Análisis de Cifrado
     */
    function getChordSuggestion(activeRelIntervals) {
        if (activeRelIntervals.size === 0) return "...";
        
        const has = (val) => activeRelIntervals.has(val);
        const rootName = NOTE_NAMES[currentRoot];
        let quality = "";
        let tensions = [];

        // Tríada Base
        if (has(4) && has(7)) quality = ""; // Mayor
        else if (has(3) && has(7)) quality = "m"; // Menor
        else if (has(3) && has(6)) quality = "dim"; // Disminuido
        else if (has(4) && has(8)) quality = "aug"; // Aumentado
        else if (has(5) && has(7)) quality = "sus4"; // Sus4
        else if (has(2) && has(7)) quality = "sus2"; // Sus2
        else if (has(7)) quality = "5"; // Power chord
        else quality = "(omit5)";

        // Séptimas
        if (has(11)) quality += "maj7";
        else if (has(10)) {
            if (quality === "dim") quality = "m7b5"; // Semidisminuido
            else quality += "7";
        } else if (has(9) && quality === "dim") {
            quality = "dim7"; // Disminuido 7
        }

        // Tensiones y agregados
        if (has(2) && !quality.includes("sus")) tensions.push("9");
        if (has(1)) tensions.push("b9");
        if (has(3) && has(4)) tensions.push("#9");
        if (has(5) && has(4)) tensions.push("add11");
        if (has(6)) tensions.push("#11");
        if (has(8) && has(7)) tensions.push("b13");
        if (has(9) && quality !== "dim7") tensions.push("13");

        let result = rootName + quality;
        if (tensions.length > 0) result += " (" + tensions.join(",") + ")";
        
        return result;
    }

    function updateVisuals() {
        const nodes = [];
        const activeRelIntervals = new Set();

        for (let i = 0; i < 12; i++) {
            const relIdx = getRelativeInterval(i);
            const angle = (relIdx * 30 - 90) * (Math.PI / 180);
            const isActive = activePitches.has(i);
            if (isActive) activeRelIntervals.add(relIdx);

            nodes.push({
                pitch: i,
                relIdx: relIdx,
                name: NOTE_NAMES[i],
                intervalName: INTERVAL_NAMES[relIdx],
                x: centerX + radius * Math.cos(angle),
                y: centerY + radius * Math.sin(angle),
                color: COLORS[relIdx],
                active: isActive
            });
        }

        const links = [];
        const activeNodes = nodes.filter(n => n.active);
        for (let i = 0; i < activeNodes.length; i++) {
            for (let j = i + 1; j < activeNodes.length; j++) {
                const p1 = activeNodes[i].pitch;
                const p2 = activeNodes[j].pitch;
                const diff = Math.abs(p1 - p2);
                const interval = diff > 6 ? 12 - diff : diff;
                links.push({
                    source: activeNodes[i],
                    target: activeNodes[j],
                    label: INTERVAL_NAMES[interval]
                });
            }
        }

        // Renderizado de Líneas
        const lines = linkG.selectAll(".interval-line")
            .data(links, d => `${d.source.pitch}-${d.target.pitch}`);

        lines.exit().remove();
        lines.enter().append("line")
            .attr("class", "interval-line")
            .attr("stroke", "#475569")
            .attr("stroke-width", 1.5)
            .merge(lines)
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        // Etiquetas
        const labels = labelG.selectAll(".interval-text")
            .data(links, d => `${d.source.pitch}-${d.target.pitch}`);
        
        labels.exit().remove();
        labels.enter().append("text")
            .attr("class", "interval-label interval-text")
            .attr("text-anchor", "middle")
            .merge(labels)
            .attr("x", d => (d.source.x + d.target.x) / 2)
            .attr("y", d => (d.source.y + d.target.y) / 2)
            .attr("dy", -5)
            .text(d => d.label);

        // Nodos (Capa superior)
        const nodeSelection = nodeG.selectAll(".node-group")
            .data(nodes, d => d.pitch);

        const nodeEnter = nodeSelection.enter().append("g")
            .attr("class", "node-group")
            .on("click", (e, d) => {
                const duration = parseFloat(document.getElementById('duration-slider').value);
                if (activePitches.has(d.pitch)) activePitches.delete(d.pitch);
                else {
                    activePitches.add(d.pitch);
                    playNote(d.pitch, duration);
                }
                updateVisuals();
            });

        nodeEnter.append("circle")
            .attr("class", "node")
            .attr("r", 22);

        nodeEnter.append("text")
            .attr("class", "node-text")
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .style("font-size", "11px")
            .style("font-weight", "bold")
            .style("pointer-events", "none");

        const nodeUpdate = nodeEnter.merge(nodeSelection);

        nodeUpdate.select("circle")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("fill", d => d.active ? d.color : "#0f172a")
            .attr("stroke", d => d.color)
            .attr("class", d => d.active ? "node node-active" : "node")
            .style("opacity", d => d.active ? 1 : 0.5);

        nodeUpdate.select("text")
            .attr("x", d => d.x)
            .attr("y", d => d.y)
            .attr("fill", d => d.active ? "#020617" : d.color)
            .text(d => d.intervalName);

        updateInfoPanel(activeNodes, links, activeRelIntervals);
    }

    function updateInfoPanel(activeNodes, links, activeRelIntervals) {
        const chordSuggestionEl = document.getElementById('suggested-chord');
        const intervalListEl = document.getElementById('interval-list');
        const countEl = document.getElementById('int-count');
        countEl.innerText = links.length;
        
        chordSuggestionEl.innerText = getChordSuggestion(activeRelIntervals);

        if (activeNodes.length === 0) {
            intervalListEl.innerHTML = "";
            return;
        }

        const sorted = activeNodes.sort((a, b) => a.relIdx - b.relIdx);
        intervalListEl.innerHTML = sorted.map(n => `
            <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-mono" style="color:${n.color}">
                ${n.name}
            </span>
        `).join('');
    }

    // Inicialización UI
    const rootContainer = document.getElementById('root-btns-container');
    NOTE_NAMES.forEach((note, i) => {
        const btn = document.createElement('div');
        btn.className = `root-btn ${i === currentRoot ? 'active' : ''}`;
        btn.innerText = note;
        btn.onclick = () => {
            currentRoot = i;
            document.querySelectorAll('.root-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateVisuals();
        };
        rootContainer.appendChild(btn);
    });

    // Event Listeners
    document.getElementById('play-chord-btn').onclick = playActiveChord;
    document.getElementById('duration-slider').oninput = function() {
        document.getElementById('dur-val').innerText = this.value + "s";
    };
    document.getElementById('volume-slider').oninput = function() {
        masterGain.gain.value = this.value / 100;
        document.getElementById('vol-val').innerText = this.value + "%";
    };

    updateVisuals();

    window.addEventListener('resize', () => {
        location.reload();
    });

</script>
</body>
</html>