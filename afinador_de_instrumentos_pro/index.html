<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afinador de Instrumentos Pro (v2)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter, la estándar moderna de Tailwind */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Mejora la respuesta táctil en móviles */
        }
        
        /* Estilos personalizados para el slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4a5568; /* gris-700 */
            border-radius: 9999px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type=range]:hover {
            opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #cbd5e0; /* gris-400 */
            border-radius: 50%;
            cursor: pointer;
            transition: background .2s;
        }
        input[type=range]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #cbd5e0; /* gris-400 */
            border-radius: 50%;
            cursor: pointer;
            transition: background .2s;
        }
        input[type=range]:active::-webkit-slider-thumb {
            background: #f7fafc; /* gris-100 */
        }
        input[type=range]:active::-moz-range-thumb {
            background: #f7fafc; /* gris-100 */
        }

        /* La "aguja" del afinador */
        #needle {
            width: 4px;
            height: 80px;
            background-color: white;
            position: absolute;
            left: 50%; /* Controlado por JS */
            top: 50%;
            /* MEJORA: La aguja ahora se centra a sí misma con transform */
            transform: translate(-50%, -50%); 
            /* MEJORA: Se añade 'left' a la transición para un movimiento suave */
            transition: transform 0.1s linear, background-color 0.1s linear, left 0.1s linear;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Barra de afinación visual */
        #tuner-visual {
            position: relative;
            width: 100%;
            height: 80px;
            background: linear-gradient(to right, 
                #ef4444 0%, /* red-500 (bemol) */
                #ef4444 30%,
                #4ade80 48%, /* green-400 (afinado) */
                #4ade80 52%,
                #ef4444 70%, /* red-500 (sostenido) */
                #ef4444 100%
            );
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Línea central de afinación */
        #tuner-visual::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: rgba(255, 255, 255, 0.4);
            transform: translateX(-50%);
        }

        /* Clase para estado "afinado" */
        .in-tune {
            color: #4ade80 !important; /* green-400 */
        }
        .in-tune-needle {
            background-color: #4ade80 !important; /* green-400 */
            box-shadow: 0 0 20px #4ade80;
            /* MEJORA: Se simplifica el transform, el movimiento es por 'left' */
            transform: translate(-50%, -50%) scaleY(1.1) !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <!-- Contenedor principal del afinador -->
        <div id="tuner-app" class="bg-gray-800 rounded-2xl shadow-2xl p-6 space-y-6 hidden">
            
            <!-- 1. Pantalla de la nota -->
            <div class="text-center">
                <div id="note-display" class="text-8xl md:text-9xl font-bold text-gray-500 transition-colors duration-100" style="min-height: 110px;">
                    --
                </div>
                <div id="cents-display" class="text-2xl font-light text-gray-400" style="min-height: 32px;">
                    &nbsp;
                </div>
            </div>

            <!-- 2. Visualizador de afinación -->
            <div id="tuner-visual">
                <div id="needle"></div>
            </div>

            <!-- 3. Controles de frecuencia -->
            <div class="space-y-4 pt-4">
                <div class="flex justify-between items-center">
                    <label for="a4-slider" class="text-sm text-gray-400">A4 Frecuencia</label>
                    <span id="a4-freq-display" class="font-semibold text-lg text-white">440 Hz</span>
                </div>
                <input type="range" id="a4-slider" min="430" max="450" value="440" step="0.5">
                <button id="reset-a4-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-150">
                    Restablecer a 440 Hz
                </button>
            </div>
            
            <!-- Mensaje de error -->
            <div id="error-message" class="text-red-400 text-center text-sm hidden"></div>
        </div>

        <!-- Botón de inicio para permisos -->
        <div id="start-screen" class="text-center">
            <h1 class="text-3xl font-bold text-white mb-4">Afinador Cromático</h1>
            <p class="text-gray-400 mb-8">Haz clic para activar el micrófono y comenzar a afinar.</p>
            <button id="start-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                Comenzar
            </button>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            // --- Referencias del DOM ---
            const startScreen = document.getElementById('start-screen');
            const startBtn = document.getElementById('start-btn');
            const tunerApp = document.getElementById('tuner-app');
            const noteDisplay = document.getElementById('note-display');
            const centsDisplay = document.getElementById('cents-display');
            const needle = document.getElementById('needle');
            const a4Slider = document.getElementById('a4-slider');
            const a4FreqDisplay = document.getElementById('a4-freq-display');
            const resetA4Btn = document.getElementById('reset-a4-btn');
            const errorMessage = document.getElementById('error-message');

            // --- Constantes y Estado de Audio ---
            const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            let audioContext = null;
            let analyser = null;
            let mediaStreamSource = null;
            let buffer; // Buffer para guardar los datos de audio
            let sampleRate = 44100; // Default, se actualizará
            let a4Freq = 440; // Frecuencia de A4, ajustable
            let animationFrameId = null;

            // --- MEJORA 4: Persistencia de UI ---
            let lastNoteTime = 0;
            const persistenceThreshold = 500; // ms para mantener la nota en pantalla

            // --- Configuración de Controles ---
            a4Slider.addEventListener('input', (e) => {
                a4Freq = parseFloat(e.target.value);
                a4FreqDisplay.textContent = `${a4Freq.toFixed(1)} Hz`;
            });

            resetA4Btn.addEventListener('click', () => {
                a4Freq = 440;
                a4Slider.value = 440;
                a4FreqDisplay.textContent = '440 Hz';
            });

            // --- Botón de Inicio ---
            startBtn.addEventListener('click', () => {
                startTuner();
            });

            // --- Función principal para iniciar el afinador ---
            async function startTuner() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    sampleRate = audioContext.sampleRate;
                    mediaStreamSource = audioContext.createMediaStreamSource(stream);
                    
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 2048; 
                    buffer = new Float32Array(analyser.fftSize);
                    
                    mediaStreamSource.connect(analyser);

                    startScreen.classList.add('hidden');
                    tunerApp.classList.remove('hidden');
                    
                    updatePitch();

                } catch (err) {
                    console.error('Error al obtener el micrófono:', err);
                    startScreen.innerHTML = `<p class="text-red-400">No se pudo acceder al micrófono. Por favor, revisa los permisos en tu navegador.</p>`;
                }
            }

            // --- Bucle de Detección de Tono ---
            function updatePitch() {
                analyser.getFloatTimeDomainData(buffer);
                const frequency = findFundamentalFrequency(buffer, sampleRate);

                if (frequency > 0) {
                    // Si se detecta una frecuencia, actualizar la UI
                    const noteData = getNoteData(frequency);
                    updateUI(noteData);
                    lastNoteTime = performance.now(); // MEJORA 4: Actualizar timestamp
                } else {
                    // MEJORA 4: Solo reiniciar si ha pasado el tiempo de persistencia
                    if (performance.now() - lastNoteTime > persistenceThreshold) {
                        resetUI();
                    }
                }

                animationFrameId = requestAnimationFrame(updatePitch);
            }

            // --- MEJORA 1: Algoritmo de Detección de Frecuencia (Autocorrelación) ---
            function findFundamentalFrequency(buffer, sampleRate) {
                const bufferSize = buffer.length;
                // Rangos de frecuencia más realistas y seguros para el buffer
                const minFreq = 30; // ~B0
                const maxFreq = 2000; // ~C7
                const minPeriod = Math.floor(sampleRate / maxFreq);
                // Asegurar que maxPeriod no exceda el tamaño del buffer
                const maxPeriod = Math.min(Math.floor(sampleRate / minFreq), bufferSize - 1);
                
                const threshold = 0.2; // Umbral de claridad de la nota (un poco más estricto)
                
                let minDiff = Infinity;
                let bestPeriod = 0;
                let rms = 0;

                // Calcular RMS (volumen) para ignorar el silencio
                for (let i = 0; i < bufferSize; i++) {
                    rms += buffer[i] * buffer[i];
                }
                rms = Math.sqrt(rms / bufferSize);

                if (rms < 0.01) { // Umbral de silencio
                    return -1;
                }

                // Iterar sobre los posibles períodos (lags)
                for (let period = minPeriod; period <= maxPeriod; period++) {
                    let diff = 0;
                    for (let i = 0; i < bufferSize - period; i++) {
                        const d = buffer[i] - buffer[i + period];
                        diff += d * d;
                    }
                    const avgDiff = Math.sqrt(diff / (bufferSize - period));
                    const normalizedDiff = avgDiff / (rms + 0.001); // Normalizar

                    // CORRECCIÓN: Encontrar el mínimo ABSOLUTO en todo el rango
                    // (La versión anterior se detenía prematuramente)
                    if (normalizedDiff < minDiff) {
                        minDiff = normalizedDiff;
                        bestPeriod = period;
                    }
                }
                
                // Solo aceptar la nota si el mejor período es suficientemente claro
                if (minDiff < threshold && bestPeriod > 0) {
                    return sampleRate / bestPeriod;
                }
                
                return -1; // No se encontró una frecuencia clara
            }

            // --- Conversión de Frecuencia a Nota ---
            function getNoteData(frequency) {
                const midiNum = 12 * (Math.log2(frequency / a4Freq)) + 69;
                const noteIndex = Math.round(midiNum) % 12;
                
                const noteName = NOTE_NAMES[noteIndex];
                const octave = Math.floor(Math.round(midiNum) / 12) - 1;
                
                const cents = (midiNum - Math.round(midiNum)) * 100;
                
                return {
                    noteName: noteName,
                    octave: octave,
                    cents: cents
                };
            }

            // --- Actualización de la Interfaz de Usuario ---
            function updateUI(noteData) {
                const { noteName, octave, cents } = noteData;

                // 1. Actualizar texto
                // MEJORA 2: Mostrar la octava
                noteDisplay.textContent = noteName + octave;
                centsDisplay.textContent = `${cents >= 0 ? '+' : ''}${cents.toFixed(0)} cents`;

                // 2. Mover la aguja
                // MEJORA 3: Mover la aguja usando 'left' para mayor sensibilidad
                // Mapear cents (-50 a +50) a un % de 'left' (0% a 100%)
                const leftPercentage = 50 + (cents * 1.0); // 1.0x = 50 cents es 100% del borde
                const clampedLeft = Math.max(0, Math.min(100, leftPercentage));
                
                needle.style.left = `${clampedLeft}%`;
                // El transform solo centra la aguja en su nueva posición
                needle.style.transform = `translate(-50%, -50%)`;

                // 3. Cambiar color si está afinado
                if (Math.abs(cents) < 5) { // Rango de afinación "perfecta"
                    noteDisplay.classList.add('in-tune');
                    needle.classList.add('in-tune-needle');
                } else {
                    noteDisplay.classList.remove('in-tune');
                    needle.classList.remove('in-tune-needle');
                    
                    if (cents < 0) {
                        noteDisplay.style.color = '#f8b400'; // Naranja para bemol
                    } else {
                        noteDisplay.style.color = '#ef4444'; // Rojo para sostenido
                    }
                }
            }

            // --- Reiniciar la UI cuando no hay sonido ---
            function resetUI() {
                noteDisplay.textContent = '--';
                noteDisplay.style.color = ''; // Vuelve al color por defecto (gray-500)
                noteDisplay.classList.remove('in-tune');
                centsDisplay.innerHTML = '&nbsp;';
                
                // MEJORA 3: Reiniciar la posición 'left' de la aguja
                needle.style.left = '50%';
                needle.style.transform = 'translate(-50%, -50%)';
                needle.classList.remove('in-tune-needle');
            }
        });
    </script>
</body>
</html>

