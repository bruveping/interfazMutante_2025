import React, { useState, useEffect, useRef } from 'react';
import { 
  Music, 
  Download, 
  Trash2, 
  Info,
  Play,
  Square
} from 'lucide-react';

/**
 * Editor de partituras con VexFlow, MidiWriterJS y Tone.js.
 * Soluci贸n al AudioContext y Favicon din谩mico incluida.
 */

const App = () => {
  // --- Estados de la Interfaz ---
  const [selectedDuration, setSelectedDuration] = useState('4'); 
  const [isRest, setIsRest] = useState(false);
  const [hasDot, setHasDot] = useState(false);
  const [tupletMode, setTupletMode] = useState(null); 
  const [timeSignature, setTimeSignature] = useState('4/4');
  const [notes, setNotes] = useState([]); 
  const [libLoaded, setLibLoaded] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  
  const containerRef = useRef(null);
  const synthRef = useRef(null);

  // --- Generar Favicon Din谩mico ---
  useEffect(() => {
    const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
    link.type = 'image/x-icon';
    link.rel = 'shortcut icon';
    // SVG de una nota musical convertido a Data URL
    link.href = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>';
    document.getElementsByTagName('head')[0].appendChild(link);
  }, []);

  // --- Carga de Dependencias Externas ---
  useEffect(() => {
    const loadScript = (src) => {
      return new Promise((resolve) => {
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = resolve;
        document.head.appendChild(script);
      });
    };

    Promise.all([
      loadScript('https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js'),
      loadScript('https://cdn.jsdelivr.net/npm/midi-writer-js@2.1.4/browser/index.js'),
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js')
    ]).then(() => {
      setLibLoaded(true);
    });
  }, []);

  // --- Inicializaci贸n y Reanudaci贸n de Audio ---
  const ensureAudioContext = async () => {
    if (!window.Tone) return;
    
    // Si el sintetizador no existe, lo creamos
    if (!synthRef.current) {
      synthRef.current = new window.Tone.PolySynth(window.Tone.Synth).toDestination();
    }

    // Reanudar el contexto si est谩 suspendido (pol铆tica de navegadores)
    if (window.Tone.context.state !== 'running') {
      await window.Tone.start();
      await window.Tone.context.resume();
    }
  };

  // --- L贸gica de Renderizado con VexFlow ---
  useEffect(() => {
    if (!libLoaded || !containerRef.current || !window.Vex) return;

    const VF = window.Vex.Flow;
    containerRef.current.innerHTML = '';
    
    const minWidth = containerRef.current.parentElement.clientWidth;
    const spacing = 90;
    const dynamicWidth = Math.max(minWidth, 200 + (notes.length * spacing));
    
    const renderer = new VF.Renderer(containerRef.current, VF.Renderer.Backends.SVG);
    renderer.resize(dynamicWidth, 250);
    const context = renderer.getContext();
    
    const stave = new VF.Stave(10, 40, dynamicWidth - 20);
    stave.addClef('treble').addTimeSignature(timeSignature);
    stave.setContext(context).draw();

    if (notes.length > 0) {
      const vfNotes = notes.map((n) => {
        let durationStr = n.duration;
        if (n.isRest) durationStr += 'r';
        if (n.hasDot) durationStr += 'd';

        const staveNote = new VF.StaveNote({
          clef: 'treble',
          keys: [n.key],
          duration: durationStr,
        });

        if (n.hasDot) {
          staveNote.addModifier(new VF.Dot(), 0);
        }

        return staveNote;
      });

      const tuplets = [];
      let i = 0;
      while (i < notes.length) {
        if (notes[i].tuplet) {
          const tValue = notes[i].tuplet;
          const tupletGroup = vfNotes.slice(i, i + tValue);
          if (tupletGroup.length === tValue) {
            tuplets.push(new VF.Tuplet(tupletGroup, { num_notes: tValue }));
          }
          i += tValue;
        } else {
          i++;
        }
      }

      // Legato Autom谩tico
      const slurs = [];
      let slurStart = -1;
      vfNotes.forEach((vfn, index) => {
        if (!notes[index].isRest) {
          if (slurStart === -1) slurStart = index;
        } else {
          if (slurStart !== -1 && index - slurStart > 1) {
            slurs.push(new VF.Curve(vfNotes[slurStart], vfNotes[index - 1]));
          }
          slurStart = -1;
        }
      });
      if (slurStart !== -1 && vfNotes.length - slurStart > 1) {
        slurs.push(new VF.Curve(vfNotes[slurStart], vfNotes[vfNotes.length - 1]));
      }

      const voice = new VF.Voice({ num_beats: 4000, beat_value: 4 });
      voice.setStrict(false);
      voice.addTickables(vfNotes);

      new VF.Formatter().joinVoices([voice]).format([voice], dynamicWidth - 180);
      voice.draw(context, stave);
      
      tuplets.forEach(t => t.setContext(context).draw());
      slurs.forEach(s => s.setContext(context).draw());
    }

    containerRef.current.parentElement.scrollLeft = dynamicWidth;
  }, [notes, libLoaded, timeSignature]);

  // --- Reproductor de Audio (120 BPM) ---
  const playScore = async () => {
    if (!window.Tone || notes.length === 0) return;
    
    await ensureAudioContext();
    setIsPlaying(true);
    
    const bpm = 120;
    const secondsPerBeat = 60 / bpm;
    let currentTime = window.Tone.now();

    notes.forEach((n) => {
      let durationInBeats = 4 / parseInt(n.duration);
      if (n.hasDot) durationInBeats *= 1.5;
      if (n.tuplet) durationInBeats = (durationInBeats * 2) / n.tuplet;

      if (!n.isRest) {
        const freq = n.key.replace('/', '');
        synthRef.current.triggerAttackRelease(freq, durationInBeats * secondsPerBeat * 0.9, currentTime);
      }
      currentTime += durationInBeats * secondsPerBeat;
    });

    setTimeout(() => setIsPlaying(false), (currentTime - window.Tone.now()) * 1000);
  };

  const handleStaffClick = async (e) => {
    if (!libLoaded || isPlaying) return;
    
    // Aprovechamos el clic del usuario para activar el audio
    await ensureAudioContext();

    const rect = containerRef.current.getBoundingClientRect();
    const y = e.clientY - rect.top;

    const positions = ['g/5', 'f/5', 'e/5', 'd/5', 'c/5', 'b/4', 'a/4', 'g/4', 'f/4', 'e/4', 'd/4', 'c/4'];
    const idx = Math.floor((y - 45) / 10);
    const key = positions[Math.max(0, Math.min(idx, positions.length - 1))] || 'b/4';

    // Opcional: Sonar nota al hacer clic
    if (!isRest && synthRef.current) {
      synthRef.current.triggerAttackRelease(key.replace('/', ''), "8n");
    }

    setNotes([...notes, {
      key: key,
      duration: selectedDuration,
      isRest: isRest,
      hasDot: hasDot,
      tuplet: tupletMode
    }]);
  };

  const exportMidi = () => {
    if (!window.MidiWriter) return;
    const track = new window.MidiWriter.Track();
    track.setTempo(120);

    notes.forEach(n => {
      let d = n.duration;
      if (n.hasDot) d += 'd';
      track.addEvent(new window.MidiWriter.NoteEvent({
        pitch: [n.key.replace('/', '')],
        duration: d,
        velocity: n.isRest ? 0 : 100,
        sequential: true
      }));
    });

    const write = new window.MidiWriter.Writer(track);
    const link = document.createElement('a');
    link.href = write.dataUri();
    link.download = 'sketch.mid';
    link.click();
  };

  if (!libLoaded) {
    return (
      <div className="h-screen flex items-center justify-center bg-slate-900 text-white">
        <div className="text-center animate-pulse">Preparando entorno musical...</div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen bg-white font-sans overflow-hidden">
      <header className="bg-slate-900 text-white p-3 flex justify-between items-center z-20">
        <div className="flex items-center gap-3">
          <Music className="text-blue-400" />
          <select 
            value={timeSignature}
            onChange={(e) => setTimeSignature(e.target.value)}
            className="bg-slate-800 text-white text-xs font-bold p-1 rounded border border-slate-700 outline-none"
          >
            <option value="4/4">4/4</option>
            <option value="3/4">3/4</option>
            <option value="2/4">2/4</option>
            <option value="6/8">6/8</option>
          </select>
        </div>
        
        <div className="flex gap-2">
          <button 
            onClick={isPlaying ? () => {} : playScore}
            className={`p-2 rounded-full transition-all active:scale-90 ${isPlaying ? 'bg-red-500' : 'bg-green-600 hover:bg-green-500'}`}
          >
            {isPlaying ? <Square size={18} /> : <Play size={18} fill="currentColor" />}
          </button>
          <button onClick={exportMidi} className="bg-blue-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 active:scale-95 transition-transform">
            <Download size={14} /> MIDI
          </button>
          <button onClick={() => setNotes([])} className="p-2 text-slate-400 hover:text-red-400 transition-colors">
            <Trash2 size={18} />
          </button>
        </div>
      </header>

      <main className="flex-grow overflow-x-auto overflow-y-hidden relative bg-slate-50 touch-pan-x">
        <div 
          ref={containerRef} 
          onClick={handleStaffClick}
          className="min-h-full flex items-center px-4"
        />
        <div className="absolute top-4 left-4 text-[9px] text-slate-400 font-mono uppercase tracking-widest pointer-events-none">
          Audio Activo | 120 BPM | Legato
        </div>
      </main>

      <footer className="bg-white border-t border-slate-200 p-4 pb-8 shadow-2xl z-20">
        <div className="max-w-md mx-auto space-y-4">
          <div className="flex justify-between bg-slate-100 p-1 rounded-2xl">
            {[
              { id: '1', label: '' }, { id: '2', label: '' }, { id: '4', label: '' }, { id: '8', label: '' }, { id: '16', label: '' }
            ].map((f) => (
              <button
                key={f.id}
                onClick={() => setSelectedDuration(f.id)}
                className={`flex-1 py-3 text-3xl rounded-xl transition-all ${selectedDuration === f.id ? 'bg-white shadow-md text-blue-600' : 'text-slate-400 active:bg-slate-200'}`}
              >
                {f.label}
              </button>
            ))}
          </div>

          <div className="flex gap-2 h-12">
            <button
              onClick={() => setIsRest(!isRest)}
              className={`flex-1 rounded-xl text-xs font-bold border transition-all active:scale-95 ${isRest ? 'bg-orange-500 text-white' : 'bg-white text-slate-500'}`}
            >
              SILENCIO
            </button>
            <button
              onClick={() => setHasDot(!hasDot)}
              className={`w-14 rounded-xl text-2xl font-bold border transition-all active:scale-95 ${hasDot ? 'bg-indigo-500 text-white' : 'bg-white text-slate-500'}`}
            >
              路
            </button>
            <div className="flex-grow flex bg-slate-100 p-1 rounded-xl gap-1">
              {[null, 3, 5, 6].map((m) => (
                <button
                  key={m || 'off'}
                  onClick={() => setTupletMode(m)}
                  className={`flex-1 text-[10px] font-black rounded-lg transition-colors ${tupletMode === m ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}
                >
                  {m ? `x${m}` : 'STD'}
                </button>
              ))}
            </div>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default App;
