<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Score Sketch</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #0e0e12;
    --surface: #17171f;
    --surface2: #1f1f2a;
    --accent: #e8c97a;
    --accent2: #7a9ee8;
    --accent3: #e87a9e;
    --text: #f0ede6;
    --muted: #5a5a72;
    --border: #2a2a3a;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; user-select:none; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    z-index: 30;
    gap: 8px;
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    color: var(--accent);
    letter-spacing: 0.05em;
    white-space: nowrap;
  }

  .header-controls {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: nowrap;
  }

  select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 8px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    outline: none;
    cursor: pointer;
  }

  .btn-icon {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .btn-icon:hover, .btn-icon:active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .btn-icon.danger:hover, .btn-icon.danger:active { background: var(--accent3); border-color: var(--accent3); }
  .btn-icon.playing { background: var(--accent3); border-color: var(--accent3); color: #fff; }

  .btn-midi {
    background: var(--accent2);
    border: 1px solid var(--accent2);
    color: var(--bg);
    padding: 6px 12px;
    border-radius: 10px;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
  }
  .btn-midi:hover { opacity: 0.85; }

  /* SCORE AREA */
  #score-area {
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
    background: var(--bg);
    position: relative;
    cursor: crosshair;
  }

  #score-wrapper {
    min-height: 100%;
    display: flex;
    align-items: center;
    padding: 0 20px;
    position: relative;
  }

  #score-canvas {
    flex-shrink: 0;
  }

  /* VexFlow SVG tweaks */
  #score-canvas svg {
    display: block;
  }
  #score-canvas svg * {
    stroke: var(--text) !important;
    fill: var(--text) !important;
  }
  #score-canvas svg .vf-rest * {
    fill: var(--text) !important;
  }

  .score-hint {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.1em;
    pointer-events: none;
    white-space: nowrap;
  }

  /* PITCH GUIDE overlay */
  #pitch-guide {
    position: absolute;
    right: 0; top: 0; bottom: 0;
    width: 32px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    pointer-events: none;
    padding: 10px 0;
  }

  /* TOOLBAR */
  footer {
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 12px 14px 16px;
    flex-shrink: 0;
    z-index: 30;
  }

  .toolbar-row {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
  }
  .toolbar-row:last-child { margin-bottom: 0; }

  /* DURATION BUTTONS */
  .dur-group {
    display: flex;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    flex: 1;
  }

  .dur-btn {
    flex: 1;
    padding: 10px 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
    border: none;
    background: transparent;
    position: relative;
  }

  .dur-btn svg {
    width: 28px;
    height: 38px;
    overflow: visible;
  }

  .dur-btn.active {
    background: var(--accent);
  }
  .dur-btn.active svg * { fill: var(--bg) !important; stroke: var(--bg) !important; }

  /* MODIFIER BUTTONS */
  .mod-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0 14px;
    border-radius: 12px;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.12s;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 42px;
    letter-spacing: 0.08em;
    white-space: nowrap;
  }
  .mod-btn.active {
    background: var(--accent3);
    border-color: var(--accent3);
    color: #fff;
  }
  .mod-dot {
    font-size: 22px;
    padding: 0 10px;
    width: 46px;
  }
  .mod-dot.active {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
  }

  /* TUPLET GROUP */
  .tuplet-group {
    display: flex;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    flex: 1;
    height: 42px;
  }
  .tup-btn {
    flex: 1;
    border: none;
    background: transparent;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.12s;
    border-right: 1px solid var(--border);
  }
  .tup-btn:last-child { border-right: none; }
  .tup-btn.active { background: var(--accent2); color: var(--bg); }

  /* LOADING */
  #loading {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 100;
    gap: 16px;
  }
  .loading-dot {
    display: flex; gap: 8px;
  }
  .loading-dot span {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    animation: bounce 1s infinite;
  }
  .loading-dot span:nth-child(2) { animation-delay: 0.15s; background: var(--accent2); }
  .loading-dot span:nth-child(3) { animation-delay: 0.3s; background: var(--accent3); }
  @keyframes bounce {
    0%,80%,100% { transform: scale(0.6); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
  #loading p { font-size: 11px; color: var(--muted); letter-spacing: 0.1em; }

  /* TOAST */
  #toast {
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: var(--bg);
    padding: 8px 20px; border-radius: 20px;
    font-size: 11px; font-weight: 700;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
    z-index: 200;
    white-space: nowrap;
  }
  #toast.show { opacity: 1; }

  /* NOTE INDICATOR */
  #note-indicator {
    position: fixed;
    background: var(--accent);
    color: var(--bg);
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 700;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.1s;
    z-index: 50;
    transform: translate(-50%, -130%);
  }
  #note-indicator.show { opacity: 1; }

  @media (max-width: 480px) {
    .logo { font-size: 13px; }
    .mod-btn { padding: 0 8px; font-size: 9px; }
  }
</style>
</head>
<body>

<div id="loading">
  <div style="font-family:'Playfair Display',serif;font-size:22px;color:var(--accent);">Score Sketch</div>
  <div class="loading-dot"><span></span><span></span><span></span></div>
  <p>CARGANDO MÓDULOS...</p>
</div>

<div id="toast"></div>
<div id="note-indicator"></div>

<header>
  <div class="logo">♩ Score Sketch</div>
  <div class="header-controls">
    <select id="timeSig">
      <option value="4/4">4/4</option>
      <option value="3/4">3/4</option>
      <option value="2/4">2/4</option>
      <option value="6/8">6/8</option>
      <option value="12/8">12/8</option>
    </select>
    <select id="bpmSel">
      <option value="60">60♩</option>
      <option value="80">80♩</option>
      <option value="100">100♩</option>
      <option value="120" selected>120♩</option>
      <option value="140">140♩</option>
      <option value="160">160♩</option>
      <option value="200">200♩</option>
    </select>
    <button class="btn-icon" id="btnPlay" title="Reproducir">▶</button>
    <button class="btn-midi" id="btnMidi">↓ MIDI</button>
    <button class="btn-icon danger" id="btnClear" title="Borrar todo">✕</button>
  </div>
</header>

<div id="score-area">
  <div id="score-wrapper">
    <div id="score-canvas"></div>
  </div>
  <div class="score-hint">↔ DESLIZA · TAP PARA AÑADIR NOTA</div>
</div>

<footer>
  <!-- ROW 1: Duraciones -->
  <div class="toolbar-row">
    <div class="dur-group" id="durGroup">
      <!-- Whole -->
      <button class="dur-btn" data-dur="1" title="Redonda">
        <svg viewBox="0 0 28 38"><ellipse cx="14" cy="22" rx="10" ry="6.5" stroke-width="2.2" fill="none"/></svg>
      </button>
      <!-- Half -->
      <button class="dur-btn" data-dur="2" title="Blanca">
        <svg viewBox="0 0 28 38">
          <ellipse cx="14" cy="26" rx="9" ry="5.5" stroke-width="2.2" fill="none" transform="rotate(-15 14 26)"/>
          <line x1="22.5" y1="24" x2="22.5" y2="5" stroke-width="2" fill="none"/>
        </svg>
      </button>
      <!-- Quarter -->
      <button class="dur-btn active" data-dur="4" title="Negra">
        <svg viewBox="0 0 28 38">
          <ellipse cx="14" cy="26" rx="9" ry="5.5" fill="currentColor" transform="rotate(-15 14 26)"/>
          <line x1="22.5" y1="24" x2="22.5" y2="5" stroke-width="2"/>
        </svg>
      </button>
      <!-- Eighth -->
      <button class="dur-btn" data-dur="8" title="Corchea">
        <svg viewBox="0 0 28 38">
          <ellipse cx="13" cy="26" rx="9" ry="5.5" fill="currentColor" transform="rotate(-15 13 26)"/>
          <line x1="21.5" y1="24" x2="21.5" y2="5" stroke-width="2"/>
          <path d="M21.5 5 Q30 10 23 18" stroke-width="2" fill="none"/>
        </svg>
      </button>
      <!-- Sixteenth -->
      <button class="dur-btn" data-dur="16" title="Semicorchea">
        <svg viewBox="0 0 28 38">
          <ellipse cx="12" cy="26" rx="9" ry="5.5" fill="currentColor" transform="rotate(-15 12 26)"/>
          <line x1="20.5" y1="24" x2="20.5" y2="4" stroke-width="2"/>
          <path d="M20.5 4 Q30 9 22 16" stroke-width="2" fill="none"/>
          <path d="M20.5 10 Q30 15 22 22" stroke-width="2" fill="none"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- ROW 2: Modificadores + Tresillos -->
  <div class="toolbar-row">
    <button class="mod-btn" id="btnRest">SILENCIO</button>
    <button class="mod-btn mod-dot" id="btnDot">·</button>
    <div class="tuplet-group">
      <button class="tup-btn active" data-tup="null">STD</button>
      <button class="tup-btn" data-tup="3">×3</button>
      <button class="tup-btn" data-tup="5">×5</button>
      <button class="tup-btn" data-tup="6">×6</button>
    </div>
    <button class="mod-btn" id="btnUndo">⌫</button>
  </div>
</footer>

<script>
// =============================================
// CARGA DE LIBRERÍAS
// =============================================
const LIBS = [
  'https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js',
  'https://cdn.jsdelivr.net/npm/midi-writer-js@2.1.4/browser/index.js',
  'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js'
];

function loadScript(src) {
  return new Promise(res => {
    const s = document.createElement('script');
    s.src = src; s.async = true;
    s.onload = res;
    document.head.appendChild(s);
  });
}

Promise.all(LIBS.map(loadScript)).then(init);

// =============================================
// ESTADO
// =============================================
let notes = [];
let selectedDuration = '4';
let isRest = false;
let hasDot = false;
let tupletMode = null;
let isPlaying = false;
let synth = null;
let partId = 0; // for sequential renders

// =============================================
// INIT
// =============================================
function init() {
  document.getElementById('loading').style.display = 'none';
  
  if (window.Tone) {
    synth = new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: 'triangle' },
      envelope: { attack: 0.02, decay: 0.1, sustain: 0.5, release: 0.8 }
    }).toDestination();
    synth.maxPolyphony = 8;
  }

  bindEvents();
  renderScore();
}

// =============================================
// BIND EVENTS
// =============================================
function bindEvents() {
  // Duration buttons
  document.querySelectorAll('.dur-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedDuration = btn.dataset.dur;
    });
  });

  // Rest
  document.getElementById('btnRest').addEventListener('click', () => {
    isRest = !isRest;
    document.getElementById('btnRest').classList.toggle('active', isRest);
  });

  // Dot
  document.getElementById('btnDot').addEventListener('click', () => {
    hasDot = !hasDot;
    document.getElementById('btnDot').classList.toggle('active', hasDot);
  });

  // Tuplets
  document.querySelectorAll('.tup-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tup-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      tupletMode = btn.dataset.tup === 'null' ? null : parseInt(btn.dataset.tup);
    });
  });

  // Undo
  document.getElementById('btnUndo').addEventListener('click', () => {
    if (notes.length > 0) {
      notes.pop();
      renderScore();
      showToast('Nota eliminada');
    }
  });

  // Play
  document.getElementById('btnPlay').addEventListener('click', togglePlay);

  // MIDI
  document.getElementById('btnMidi').addEventListener('click', exportMidi);

  // Clear
  document.getElementById('btnClear').addEventListener('click', () => {
    if (notes.length === 0) return;
    notes = [];
    renderScore();
    showToast('Partitura borrada');
  });

  // Score click
  const scoreArea = document.getElementById('score-area');
  scoreArea.addEventListener('click', onScoreClick);
  scoreArea.addEventListener('touchend', onScoreTouch, { passive: false });

  // Prevent scroll on touch inside score area if horizontal
  let touchStartX = 0;
  scoreArea.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
}

// =============================================
// SCORE CLICK / TOUCH
// =============================================
function onScoreTouch(e) {
  // Only handle if not scrolling
  const dx = Math.abs(e.changedTouches[0].clientX - touchStartX);
  if (dx > 10) return; // was a scroll
  e.preventDefault();
  handleScoreInteraction(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
}

function onScoreClick(e) {
  if (e.target.closest('footer') || e.target.closest('header')) return;
  handleScoreInteraction(e.clientX, e.clientY);
}

let touchStartX = 0;

function handleScoreInteraction(cx, cy) {
  if (isPlaying) return;
  const canvas = document.getElementById('score-canvas');
  const rect = canvas.getBoundingClientRect();
  const y = cy - rect.top;

  // Map Y position to pitch
  const pitch = yToPitch(y);
  if (!pitch) return;

  const note = {
    key: isRest ? 'b/4' : pitch,
    display: isRest ? '—' : pitch.replace('/', '').toUpperCase(),
    duration: selectedDuration,
    isRest,
    hasDot,
    tuplet: tupletMode
  };

  // Group tuplets: accumulate and assign group id
  if (tupletMode) {
    const gid = notes.filter(n => n.tuplet === tupletMode && n.tupletGroupId === getCurrentTupletGroupId(tupletMode)).length;
    note.tupletGroupId = getCurrentTupletGroupId(tupletMode);
  }

  notes.push(note);
  renderScore();

  // Show indicator
  showNoteIndicator(cx, cy, note.display + (isRest ? ' silencio' : '') + (hasDot ? '·' : ''));
}

function getCurrentTupletGroupId(t) {
  const relevant = notes.filter(n => n.tuplet === t);
  if (relevant.length === 0) return 0;
  const lastGroupId = relevant[relevant.length - 1].tupletGroupId || 0;
  const countInGroup = relevant.filter(n => n.tupletGroupId === lastGroupId).length;
  return countInGroup >= t ? lastGroupId + 1 : lastGroupId;
}

// =============================================
// PITCH MAPPING
// =============================================
const PITCHES = [
  'a/5','g/5','f/5','e/5','d/5','c/5',
  'b/4','a/4','g/4','f/4','e/4','d/4','c/4','b/3','a/3'
];

function yToPitch(y) {
  // Staff is rendered at ~40px from top, each step ~10px
  const staveTop = 50;
  const stepPx = 10;
  const idx = Math.round((y - staveTop) / stepPx);
  const clamped = Math.max(0, Math.min(idx, PITCHES.length - 1));
  return PITCHES[clamped];
}

// =============================================
// RENDER SCORE (VexFlow)
// =============================================
function renderScore() {
  if (!window.Vex) return;
  const VF = window.Vex.Flow;
  const container = document.getElementById('score-canvas');
  container.innerHTML = '';

  const timeSig = document.getElementById('timeSig').value;
  const parentW = document.getElementById('score-area').clientWidth;
  const noteSpacing = 100;
  const staveW = Math.max(parentW - 40, 300 + notes.length * noteSpacing);

  const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
  renderer.resize(staveW, 220);
  const ctx = renderer.getContext();

  // Style SVG
  const svg = container.querySelector('svg');
  if (svg) {
    svg.style.background = 'transparent';
  }

  const stave = new VF.Stave(10, 40, staveW - 20);
  stave.addClef('treble').addTimeSignature(timeSig);
  stave.setContext(ctx).draw();

  if (notes.length === 0) {
    // Draw placeholder text
    ctx.setFont('Space Mono', 11);
    ctx.setFillStyle('rgba(90,90,114,0.6)');
    ctx.fillText('TAP AQUÍ PARA AÑADIR NOTAS', 160, 105);
    return;
  }

  // Build VexFlow notes
  const vfNotes = notes.map(n => {
    let durStr = n.duration;
    if (n.isRest) durStr += 'r';
    if (n.hasDot) durStr += 'd';

    const sn = new VF.StaveNote({
      clef: 'treble',
      keys: [n.key],
      duration: durStr,
      auto_stem: true
    });

    if (n.hasDot) sn.addModifier(new VF.Dot(), 0);
    return sn;
  });

  // Tuplets
  const tuplets = [];
  let i = 0;
  while (i < notes.length) {
    if (notes[i].tuplet) {
      const tv = notes[i].tuplet;
      const gid = notes[i].tupletGroupId;
      // Find all notes in this group
      const groupIndices = [];
      for (let j = i; j < notes.length && groupIndices.length < tv; j++) {
        if (notes[j].tuplet === tv && notes[j].tupletGroupId === gid) {
          groupIndices.push(j);
        }
      }
      if (groupIndices.length === tv) {
        const group = groupIndices.map(idx => vfNotes[idx]);
        try {
          tuplets.push(new VF.Tuplet(group, { num_notes: tv, notes_occupied: tv === 3 ? 2 : tv }));
        } catch(e) {}
        i = groupIndices[groupIndices.length - 1] + 1;
      } else { i++; }
    } else { i++; }
  }

  // Voice
  const voice = new VF.Voice({ num_beats: 4000, beat_value: 4 }).setStrict(false);
  voice.addTickables(vfNotes);

  new VF.Formatter().joinVoices([voice]).format([voice], staveW - 200);
  voice.draw(ctx, stave);
  tuplets.forEach(t => { try { t.setContext(ctx).draw(); } catch(e){} });

  // Auto scroll to end
  const area = document.getElementById('score-area');
  setTimeout(() => { area.scrollLeft = area.scrollWidth; }, 50);
}

// =============================================
// PLAY
// =============================================
async function togglePlay() {
  if (isPlaying) { stopPlay(); return; }
  if (!synth || notes.length === 0) return;
  
  try {
    await Tone.start();
  } catch(e) {}

  isPlaying = true;
  document.getElementById('btnPlay').textContent = '■';
  document.getElementById('btnPlay').classList.add('playing');

  const bpm = parseInt(document.getElementById('bpmSel').value);
  const spb = 60 / bpm;
  let t = Tone.now() + 0.1;
  let totalDur = 0;

  notes.forEach(n => {
    let beats = 4 / parseInt(n.duration);
    if (n.hasDot) beats *= 1.5;
    if (n.tuplet === 3) beats = beats * 2 / 3;
    else if (n.tuplet === 5) beats = beats * 4 / 5;
    else if (n.tuplet === 6) beats = beats * 4 / 6;

    const dur = beats * spb;

    if (!n.isRest) {
      try {
        // Convert VexFlow key to Tone.js format: c/4 -> C4
        const toneNote = vexToTone(n.key);
        synth.triggerAttackRelease(toneNote, dur * 0.88, t);
      } catch(e) {}
    }
    t += dur;
    totalDur += dur;
  });

  const endTimer = setTimeout(() => stopPlay(), totalDur * 1000 + 200);
  window._scorePlayTimer = endTimer;
}

function stopPlay() {
  isPlaying = false;
  document.getElementById('btnPlay').textContent = '▶';
  document.getElementById('btnPlay').classList.remove('playing');
  if (window._scorePlayTimer) clearTimeout(window._scorePlayTimer);
  try { synth.releaseAll(); } catch(e) {}
}

function vexToTone(key) {
  const parts = key.split('/');
  const note = parts[0].toUpperCase();
  const octave = parts[1];
  return note + octave;
}

// =============================================
// EXPORT MIDI
// =============================================
function exportMidi() {
  if (!window.MidiWriter) { showToast('MidiWriter no disponible'); return; }
  if (notes.length === 0) { showToast('No hay notas para exportar'); return; }

  const track = new MidiWriter.Track();
  track.setTempo(parseInt(document.getElementById('bpmSel').value));

  notes.forEach(n => {
    let dur = n.duration;
    if (n.hasDot) dur = dur + 'd';

    if (n.isRest) {
      track.addEvent(new MidiWriter.NoteEvent({
        pitch: ['C4'], duration: dur, velocity: 0, sequential: true
      }));
    } else {
      const midiNote = vexToMidi(n.key);
      track.addEvent(new MidiWriter.NoteEvent({
        pitch: [midiNote], duration: dur, velocity: 90, sequential: true
      }));
    }
  });

  const writer = new MidiWriter.Writer(track);
  const link = document.createElement('a');
  link.href = writer.dataUri();
  link.download = 'score-sketch.mid';
  link.click();
  showToast('MIDI descargado ✓');
}

function vexToMidi(key) {
  const parts = key.split('/');
  const note = parts[0].toUpperCase();
  const octave = parts[1];
  return note + octave;
}

// =============================================
// UI HELPERS
// =============================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1800);
}

function showNoteIndicator(x, y, label) {
  const el = document.getElementById('note-indicator');
  el.textContent = label;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 600);
}

// Re-render on resize
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(renderScore, 200);
});

// Re-render on time sig change
document.getElementById('timeSig').addEventListener('change', renderScore);
</script>
</body>
</html>
