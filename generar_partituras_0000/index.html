<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Sketcher Vanilla</title>
    <!-- Favicon din치mico -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>游꿧</text></svg>">
    
    <!-- Librer칤as Externas -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi-writer-js@2.1.4/browser/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { touch-action: manipulation; }
        .no-select { user-select: none; -webkit-user-select: none; }
        #staff-container::-webkit-scrollbar { height: 6px; }
        #staff-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        /* Estilo para el slider de volumen */
        input[type=range] {
            accent-color: #2563eb;
        }
    </style>
</head>
<body class="bg-slate-50 flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-3 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
            </div>
            <select id="time-signature" class="bg-slate-800 text-white text-xs font-bold p-1 rounded border border-slate-700 outline-none">
                <option value="4/4">4/4</option>
                <option value="3/4">3/4</option>
                <option value="2/4">2/4</option>
                <option value="6/8">6/8</option>
            </select>
        </div>
        
        <!-- Control de Volumen -->
        <div class="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.7" class="w-16 sm:w-24 h-1.5 bg-slate-600 rounded-lg appearance-none cursor-pointer">
        </div>

        <div class="flex gap-2">
            <button id="btn-play" class="p-2 bg-green-600 hover:bg-green-500 rounded-full transition-all active:scale-90 shadow-md">
                <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <svg id="icon-stop" class="hidden" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"></rect></svg>
            </button>
            <button id="btn-midi" class="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 active:scale-95 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                MIDI
            </button>
            <button id="btn-clear" class="p-2 text-slate-400 hover:text-red-400 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
        </div>
    </header>

    <!-- 츼rea de Dibujo -->
    <main id="staff-container" class="flex-grow overflow-x-auto overflow-y-hidden relative bg-slate-50 touch-pan-x flex items-center">
        <div id="staff-output" class="min-h-[250px] px-8 cursor-crosshair"></div>
        <div id="empty-msg" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none p-4 text-center">
            <p class="text-lg font-medium">Toca aqu칤 para a침adir una nota</p>
            <p class="text-[10px] uppercase tracking-widest mt-2">120 BPM | Clave de Sol</p>
        </div>
    </main>

    <!-- Toolbar Inferior -->
    <footer class="bg-white border-t border-slate-200 p-4 pb-8 shadow-2xl z-20 no-select">
        <div class="max-w-md mx-auto space-y-4">
            <!-- Figuras -->
            <div id="fig-selector" class="flex justify-between bg-slate-100 p-1 rounded-2xl">
                <button data-val="1" class="fig-btn flex-1 py-3 text-3xl rounded-xl transition-all text-slate-400">洧</button>
                <button data-val="2" class="fig-btn flex-1 py-3 text-3xl rounded-xl transition-all text-slate-400">洧</button>
                <button data-val="4" class="fig-btn flex-1 py-3 text-3xl rounded-xl transition-all bg-white shadow-md text-blue-600">洧</button>
                <button data-val="8" class="fig-btn flex-1 py-3 text-3xl rounded-xl transition-all text-slate-400">洧</button>
                <button data-val="16" class="fig-btn flex-1 py-3 text-3xl rounded-xl transition-all text-slate-400">洧ㅗ</button>
            </div>

            <!-- Modificadores -->
            <div class="flex gap-2 h-12">
                <button id="btn-rest" class="flex-1 rounded-xl text-[10px] font-black border border-slate-200 text-slate-500 bg-white transition-all active:scale-95">SILENCIO</button>
                <button id="btn-dot" class="w-14 rounded-xl text-2xl font-black border border-slate-200 text-slate-500 bg-white transition-all active:scale-95">췅</button>
                <div class="flex-grow flex bg-slate-100 p-1 rounded-xl gap-1">
                    <button data-t="null" class="tuplet-btn flex-1 text-[9px] font-black rounded-lg bg-white text-blue-600 shadow-sm">STD</button>
                    <button data-t="3" class="tuplet-btn flex-1 text-[9px] font-black rounded-lg text-slate-400">x3</button>
                    <button data-t="5" class="tuplet-btn flex-1 text-[9px] font-black rounded-lg text-slate-400">x5</button>
                    <button data-t="6" class="tuplet-btn flex-1 text-[9px] font-black rounded-lg text-slate-400">x6</button>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // --- Configuraci칩n Inicial ---
        let notes = [];
        let selectedDuration = '4';
        let isRest = false;
        let hasDot = false;
        let tupletMode = null;
        let isPlaying = false;
        let synth = null;

        const staffOutput = document.getElementById('staff-output');
        const emptyMsg = document.getElementById('empty-msg');
        const volSlider = document.getElementById('volume-slider');

        // --- Inicializaci칩n de Audio ---
        async function ensureAudio() {
            if (!synth) {
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                updateVolume(); // Aplicar volumen inicial
            }
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
        }

        function updateVolume() {
            if (synth) {
                // Mapeo de 0-1 a decibelios (Tone.js usa dB)
                // -Infinity (0) a 0dB (1)
                const val = parseFloat(volSlider.value);
                const db = val === 0 ? -100 : 20 * Math.log10(val);
                synth.volume.value = db;
            }
        }

        volSlider.addEventListener('input', updateVolume);

        // --- L칩gica de VexFlow ---
        function renderScore() {
            staffOutput.innerHTML = '';
            const VF = Vex.Flow;
            const containerWidth = staffOutput.parentElement.clientWidth;
            const spacing = 95;
            const dynamicWidth = Math.max(containerWidth, 200 + (notes.length * spacing));
            
            const renderer = new VF.Renderer(staffOutput, VF.Renderer.Backends.SVG);
            renderer.resize(dynamicWidth, 250);
            const context = renderer.getContext();
            
            const stave = new VF.Stave(10, 40, dynamicWidth - 40);
            const timeSig = document.getElementById('time-signature').value;
            stave.addClef('treble').addTimeSignature(timeSig);
            stave.setContext(context).draw();

            if (notes.length > 0) {
                emptyMsg.classList.add('hidden');
                
                const vfNotes = notes.map(n => {
                    let d = n.duration;
                    if (n.isRest) d += 'r';
                    if (n.hasDot) d += 'd';

                    const sn = new VF.StaveNote({ clef: 'treble', keys: [n.key], duration: d });
                    if (n.hasDot) sn.addModifier(new VF.Dot(), 0);
                    return sn;
                });

                // Tuplets
                const tuplets = [];
                let i = 0;
                while (i < notes.length) {
                    if (notes[i].tuplet) {
                        const tVal = parseInt(notes[i].tuplet);
                        const group = vfNotes.slice(i, i + tVal);
                        if (group.length === tVal) tuplets.push(new VF.Tuplet(group, { num_notes: tVal }));
                        i += tVal;
                    } else i++;
                }

                // Legato Autom치tico (DESACTIVADO por solicitud del usuario)
                // Se elimin칩 la l칩gica de VF.Curve aqu칤.

                const voice = new VF.Voice({ num_beats: 4000, beat_value: 4 });
                voice.setStrict(false);
                voice.addTickables(vfNotes);

                new VF.Formatter().joinVoices([voice]).format([voice], dynamicWidth - 180);
                voice.draw(context, stave);
                tuplets.forEach(t => t.setContext(context).draw());
            } else {
                emptyMsg.classList.remove('hidden');
            }
            
            // Scroll autom치tico
            staffOutput.parentElement.scrollLeft = dynamicWidth;
        }

        // --- Eventos ---
        staffOutput.addEventListener('click', async (e) => {
            if (isPlaying) return;
            await ensureAudio();

            const rect = staffOutput.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const positions = ['g/5', 'f/5', 'e/5', 'd/5', 'c/5', 'b/4', 'a/4', 'g/4', 'f/4', 'e/4', 'd/4', 'c/4'];
            const idx = Math.floor((y - 45) / 10);
            const key = positions[Math.max(0, Math.min(idx, positions.length - 1))] || 'b/4';

            if (!isRest && synth) synth.triggerAttackRelease(key.replace('/', ''), "8n");

            notes.push({ key, duration: selectedDuration, isRest, hasDot, tuplet: tupletMode });
            renderScore();
        });

        // Controles de Figura
        document.querySelectorAll('.fig-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.fig-btn').forEach(b => {
                    b.classList.remove('bg-white', 'shadow-md', 'text-blue-600');
                    b.classList.add('text-slate-400');
                });
                btn.classList.add('bg-white', 'shadow-md', 'text-blue-600');
                btn.classList.remove('text-slate-400');
                selectedDuration = btn.dataset.val;
            });
        });

        document.getElementById('btn-rest').onclick = (e) => {
            isRest = !isRest;
            e.target.className = isRest 
                ? "flex-1 rounded-xl text-[10px] font-black border border-orange-600 text-white bg-orange-500 shadow-md"
                : "flex-1 rounded-xl text-[10px] font-black border border-slate-200 text-slate-500 bg-white";
        };

        document.getElementById('btn-dot').onclick = (e) => {
            hasDot = !hasDot;
            e.target.className = hasDot 
                ? "w-14 rounded-xl text-2xl font-black border border-indigo-600 text-white bg-indigo-500 shadow-md"
                : "w-14 rounded-xl text-2xl font-black border border-slate-200 text-slate-500 bg-white";
        };

        document.querySelectorAll('.tuplet-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tuplet-btn').forEach(b => {
                    b.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                    b.classList.add('text-slate-400');
                });
                btn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                btn.classList.remove('text-slate-400');
                tupletMode = btn.dataset.t === 'null' ? null : btn.dataset.t;
            });
        });

        document.getElementById('time-signature').onchange = renderScore;
        document.getElementById('btn-clear').onclick = () => { notes = []; renderScore(); };

        // Reproductor
        document.getElementById('btn-play').onclick = async () => {
            if (notes.length === 0) return;
            await ensureAudio();
            
            isPlaying = true;
            document.getElementById('icon-play').classList.add('hidden');
            document.getElementById('icon-stop').classList.remove('hidden');

            const bpm = 120;
            const step = 60 / bpm;
            let now = Tone.now();

            notes.forEach(n => {
                let durBeats = 4 / parseInt(n.duration);
                if (n.hasDot) durBeats *= 1.5;
                if (n.tuplet) durBeats = (durBeats * 2) / parseInt(n.tuplet);

                if (!n.isRest) {
                    synth.triggerAttackRelease(n.key.replace('/', ''), durBeats * step * 0.9, now);
                }
                now += durBeats * step;
            });

            setTimeout(() => {
                isPlaying = false;
                document.getElementById('icon-play').classList.remove('hidden');
                document.getElementById('icon-stop').classList.add('hidden');
            }, (now - Tone.now()) * 1000);
        };

        // Exportar MIDI
        document.getElementById('btn-midi').onclick = () => {
            if (notes.length === 0) return;
            const track = new MidiWriter.Track();
            track.setTempo(120);
            notes.forEach(n => {
                let d = n.duration;
                if (n.hasDot) d += 'd';
                track.addEvent(new MidiWriter.NoteEvent({
                    pitch: [n.key.replace('/', '')],
                    duration: d,
                    velocity: n.isRest ? 0 : 100,
                    sequential: true
                }));
            });
            const write = new MidiWriter.Writer(track);
            const a = document.createElement('a');
            a.href = write.dataUri();
            a.download = 'partitura.mid';
            a.click();
        };

        // Render inicial
        window.onload = renderScore;
    </script>
</body>
</html>
