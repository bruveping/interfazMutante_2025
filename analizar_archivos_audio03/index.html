<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Analyzer Pro + Playlist</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒŠ</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --waveform-color: #06b6d4; /* Cyan 500 */
            --cursor-color: #f43f5e;   /* Rose 500 */
            --bg-dark: #111827;        /* Gray 900 */
            --active-item: #1f2937;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e5e7eb;
            overflow: hidden; 
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Canvas Containers */
        .canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #0f1115;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #374151;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* Sliders */
        input[type=range].control-slider { -webkit-appearance: none; background: transparent; }
        input[type=range].control-slider::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #06b6d4; cursor: pointer;
            margin-top: -6px; box-shadow: 0 0 5px rgba(6, 182, 212, 0.5);
        }
        input[type=range].control-slider::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #374151; border-radius: 2px;
        }

        /* Scrubber */
        #scrubber-slider {
            -webkit-appearance: none; appearance: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent; z-index: 20; cursor: pointer; margin: 0;
        }
        #scrubber-slider:focus { outline: none; }
        #scrubber-slider::-webkit-slider-runnable-track { width: 100%; height: 100%; background: transparent; border: none; }
        #scrubber-slider::-webkit-slider-thumb {
            -webkit-appearance: none; height: 100%; width: 2px;
            background: rgba(244, 63, 94, 0.01); cursor: col-resize; margin-top: 0;
        }

        .playlist-item.active {
            background-color: rgba(6, 182, 212, 0.15);
            border-left: 3px solid #06b6d4;
        }
        .btn-control:active { transform: scale(0.95); }

        /* Tabs styling */
        .tab-btn {
            border-bottom: 2px solid transparent;
            color: #9ca3af;
        }
        .tab-btn.active-tab {
            border-bottom: 2px solid #06b6d4;
            color: #fff;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-3">
            <div class="text-cyan-400 text-2xl">ðŸŒŠ</div>
            <div class="overflow-hidden">
                <h1 class="font-bold text-sm md:text-base leading-tight">Analizador Pro</h1>
                <div id="file-name" class="text-xs text-gray-400 mono truncate max-w-[300px]">Cola vacÃ­a</div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="document.getElementById('file-input').click()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-1.5 rounded text-sm font-semibold transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Cargar Archivos
            </button>
            <!-- Note: 'multiple' attribute added here -->
            <input type="file" id="file-input" class="hidden" accept="audio/*,video/*" multiple>
            
            <button onclick="toggleShortcuts()" class="text-gray-400 hover:text-white" title="Atajos (Ctrl+Alt+H)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left: Visualization & Controls -->
        <main class="flex-1 flex flex-col p-4 gap-4 overflow-y-auto">
            
            <!-- Spectrum -->
            <div id="spectrum-container" class="h-32 shrink-0 canvas-container relative group">
                <canvas id="spectrum-canvas"></canvas>
                <div class="absolute top-2 left-2 text-xs text-cyan-500 font-mono opacity-50">ESPECTRO (TIEMPO REAL)</div>
            </div>

            <!-- Waveform -->
            <div class="flex-1 min-h-[200px] canvas-container relative group" id="waveform-container">
                <canvas id="waveform-canvas"></canvas>
                <input type="range" id="scrubber-slider" min="0" max="1000" step="0.1" value="0">
                
                <div id="cursor" class="absolute top-0 bottom-0 w-px bg-rose-500 pointer-events-none z-10" style="left: 0%; box-shadow: 0 0 4px #f43f5e;"></div>
                <div id="marker-a" class="absolute top-0 bottom-0 w-0 border-l-2 border-dashed border-green-500 hidden pointer-events-none z-0"><span class="bg-green-500 text-black text-[10px] px-1 absolute top-0">A</span></div>
                <div id="marker-b" class="absolute top-0 bottom-0 w-0 border-l-2 border-dashed border-red-500 hidden pointer-events-none z-0"><span class="bg-red-500 text-black text-[10px] px-1 absolute top-0">B</span></div>
                
                <div class="absolute top-2 left-2 text-xs text-cyan-500 font-mono opacity-50 pointer-events-none">FORMA DE ONDA (TOTAL)</div>
                <div id="hover-time" class="absolute bottom-2 right-2 text-xs bg-black/80 text-white px-2 py-1 rounded hidden font-mono pointer-events-none z-30">00:00</div>
            </div>

            <!-- Dashboard -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-lg">
                <!-- Info & VU -->
                <div class="flex items-center justify-between mb-4">
                    <div class="font-mono text-xl md:text-2xl tracking-widest text-cyan-400">
                        <span id="current-time">00:00:00</span> <span class="text-gray-600">/</span> <span id="total-time" class="text-gray-400">00:00:00</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-500">L</span>
                        <div class="w-24 h-2 bg-gray-900 rounded-full overflow-hidden">
                            <div id="vu-l" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 w-0 transition-all duration-75"></div>
                        </div>
                        <div class="w-24 h-2 bg-gray-900 rounded-full overflow-hidden">
                            <div id="vu-r" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 w-0 transition-all duration-75"></div>
                        </div>
                        <span class="text-xs font-bold text-gray-500">R</span>
                    </div>
                </div>

                <!-- Transport Controls -->
                <div class="flex flex-wrap items-center justify-between gap-4">
                    
                    <div class="flex items-center gap-2">
                        <!-- Loop -->
                        <button id="btn-loop" onclick="toggleLoop()" class="btn-control p-2 rounded text-gray-400 hover:bg-gray-700" title="Bucle (Ctrl+Alt+L)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                        </button>
                        
                        <!-- Previous Track -->
                        <button onclick="playPrev()" class="btn-control p-2 text-gray-300 hover:text-white" title="Anterior (Ctrl+Alt+B)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" y1="19" x2="5" y2="5" stroke="currentColor" stroke-width="2"/></svg>
                        </button>

                        <!-- Backward 10s -->
                        <button onclick="skip(-10)" class="btn-control p-2 text-gray-300 hover:text-white" title="-10s">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h.01M10 12h.01M14 12h.01M18 12h.01"/></svg>
                        </button>

                        <!-- Play/Pause -->
                        <button id="btn-play" onclick="togglePlay()" class="btn-control bg-cyan-600 hover:bg-cyan-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg shadow-cyan-900/50" title="Play/Pause (Ctrl+Alt+P)">
                            <svg id="icon-play" class="block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            <svg id="icon-pause" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                        </button>

                        <!-- Stop -->
                        <button onclick="stopAudio()" class="btn-control p-2 text-gray-300 hover:text-red-400" title="Stop (Ctrl+Alt+S)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                        </button>

                        <!-- Forward 10s -->
                        <button onclick="skip(10)" class="btn-control p-2 text-gray-300 hover:text-white" title="+10s">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h.01M10 12h.01M14 12h.01M18 12h.01"/></svg>
                        </button>

                         <!-- Next Track -->
                         <button onclick="playNext()" class="btn-control p-2 text-gray-300 hover:text-white" title="Siguiente (Ctrl+Alt+N)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="2"/></svg>
                        </button>
                    </div>

                    <!-- AB Loop -->
                    <div class="flex items-center bg-gray-900 rounded px-2 py-1 gap-2 border border-gray-700">
                        <span class="text-xs text-gray-500 font-bold">A-B</span>
                        <button onclick="setLoopPoint('a')" class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-green-400">A</button>
                        <button onclick="setLoopPoint('b')" class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-red-400">B</button>
                        <button onclick="clearLoopPoints()" class="text-xs text-gray-500 hover:text-white">âœ•</button>
                    </div>

                    <!-- Sliders -->
                    <div class="flex items-center gap-6 flex-1 justify-end">
                        <div class="flex flex-col w-20 shrink-0">
                            <label class="text-[10px] text-gray-500 font-bold uppercase flex justify-between">
                                Speed <span id="speed-val" class="text-cyan-400">1.0x</span>
                            </label>
                            <input type="range" class="control-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="setSpeed(this.value)">
                        </div>
                        
                        <div class="flex flex-col w-48 md:w-64">
                            <label class="text-[10px] text-gray-500 font-bold uppercase flex justify-between">
                                Amp <span id="vol-val" class="text-cyan-400">100%</span>
                            </label>
                            <input id="vol-slider" class="control-slider" type="range" min="0" max="10" step="0.05" value="1.0" oninput="setVolume(this.value)">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center text-xs text-gray-600">
                <kbd class="bg-gray-700 px-1 rounded">Ctrl</kbd>+<kbd class="bg-gray-700 px-1 rounded">Alt</kbd> para controles. 'H' para ayuda.
            </div>
        </main>

        <!-- Right Panel (Sidebar with Tabs) -->
        <aside id="sidebar-panel" class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col shrink-0">
            <!-- Tabs Header -->
            <div class="flex border-b border-gray-700 bg-gray-900 text-sm font-semibold">
                <button onclick="switchTab('playlist')" id="tab-playlist" class="flex-1 py-3 text-center tab-btn active-tab hover:bg-gray-800 transition">
                    Lista (<span id="queue-count">0</span>)
                </button>
                <button onclick="switchTab('notes')" id="tab-notes" class="flex-1 py-3 text-center tab-btn hover:bg-gray-800 transition">
                    Notas
                </button>
            </div>
            
            <!-- Playlist Content -->
            <div id="view-playlist" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div id="playlist-container" class="space-y-1">
                    <div class="text-center text-gray-500 text-sm mt-10 p-4">
                        Arrastra archivos o usa "Cargar" para empezar.
                    </div>
                </div>
            </div>

            <!-- Notes Content (Hidden by default or toggled) -->
            <div id="view-notes" class="flex-1 hidden flex flex-col relative">
                <div class="flex justify-end p-2 border-b border-gray-700 bg-gray-900">
                    <button onclick="downloadNotes()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white" title="Descargar .md">â¬‡ Guardar MD</button>
                </div>
                <textarea id="notes-area" class="flex-1 w-full bg-gray-800 text-gray-300 p-4 resize-none focus:outline-none font-mono text-sm leading-relaxed" placeholder="# Notas de anÃ¡lisis&#10;Escribe aquÃ­ tus observaciones..."></textarea>
                <button onclick="insertTimestamp()" class="absolute bottom-4 right-4 bg-cyan-600/90 hover:bg-cyan-500 text-white rounded-full p-3 shadow-lg" title="Insertar Tiempo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </button>
            </div>
        </aside>

    </div>

    <!-- Shortcuts Modal -->
    <div id="shortcuts-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4" onclick="toggleShortcuts()">
        <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 max-w-2xl w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-bold text-white">Atajos de Teclado</h3>
                <button onclick="toggleShortcuts()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <h4 class="text-cyan-400 font-bold mb-2 uppercase text-xs">ReproducciÃ³n</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li class="flex justify-between"><span>Play / Pause</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+P</kbd></li>
                        <li class="flex justify-between"><span>Stop</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+S</kbd></li>
                        <li class="flex justify-between"><span class="text-white font-bold">Siguiente</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+N</kbd></li>
                        <li class="flex justify-between"><span class="text-white font-bold">Anterior</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+B</kbd></li>
                        <li class="flex justify-between"><span>Bucle On/Off</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+L</kbd></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-cyan-400 font-bold mb-2 uppercase text-xs">Puntos de Bucle</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li class="flex justify-between"><span>Marcar Punto A</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+A</kbd></li>
                        <li class="flex justify-between"><span>Marcar Punto B</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+Shift+B</kbd></li>
                    </ul>
                    <h4 class="text-cyan-400 font-bold mt-4 mb-2 uppercase text-xs">Audio</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li class="flex justify-between"><span>Ganancia (+/-)</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt+â†‘/â†“</kbd></li>
                        <li class="flex justify-between"><span>Velocidad (+/-)</span> <kbd class="bg-gray-700 px-1 rounded border border-gray-600">Ctrl+Alt +/-</kbd></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 flex flex-col items-center justify-center bg-black/50 hidden">
        <div class="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div class="text-white font-bold animate-pulse">Cargando Audio...</div>
    </div>

<script>
/**
 * AUDIO ANALYZER PRO - LOGIC
 * Includes Playlist Management & Web Audio API
 */

// --- Global State ---
let audioCtx;
let audioBuffer = null;
let sourceNode = null;
let gainNode = null;
let analyserNode = null;

// Player State
let isPlaying = false;
let isLooping = false;
let playbackStartTime = 0;
let pausedAt = 0;
let loopStart = 0;
let loopEnd = 0;
let playbackRate = 1.0;
let volume = 1.0;
let isScrubbing = false;

// Playlist State
let playlist = []; // Array of File objects
let currentTrackIndex = -1;

// Animation Frames
let rafSpectrum;
let rafWaveform;

// Elements
const fileInput = document.getElementById('file-input');
const canvasWave = document.getElementById('waveform-canvas');
const ctxWave = canvasWave.getContext('2d');
const canvasSpec = document.getElementById('spectrum-canvas');
const ctxSpec = canvasSpec.getContext('2d');
const cursorEl = document.getElementById('cursor');
const scrubberSlider = document.getElementById('scrubber-slider');
const markerAEl = document.getElementById('marker-a');
const markerBEl = document.getElementById('marker-b');
const timeDisplay = document.getElementById('current-time');
const totalTimeDisplay = document.getElementById('total-time');
const vuL = document.getElementById('vu-l');
const vuR = document.getElementById('vu-r');
const loadingOverlay = document.getElementById('loading-overlay');
const playlistContainer = document.getElementById('playlist-container');
const queueCountEl = document.getElementById('queue-count');

// --- Initialization ---
window.addEventListener('resize', resizeCanvases);
window.onload = () => {
    resizeCanvases();
    loadNotes();
};

function initAudioContext() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function resizeCanvases() {
    const waveContainer = document.getElementById('waveform-container');
    canvasWave.width = waveContainer.clientWidth;
    canvasWave.height = waveContainer.clientHeight;
    
    const specContainer = document.getElementById('spectrum-container');
    canvasSpec.width = specContainer.clientWidth;
    canvasSpec.height = specContainer.clientHeight;

    if (audioBuffer) drawStaticWaveform();
}

// --- Tabs Logic ---
function switchTab(tabName) {
    const viewPlaylist = document.getElementById('view-playlist');
    const viewNotes = document.getElementById('view-notes');
    const btnPlaylist = document.getElementById('tab-playlist');
    const btnNotes = document.getElementById('tab-notes');

    if (tabName === 'playlist') {
        viewPlaylist.classList.remove('hidden');
        viewNotes.classList.add('hidden');
        btnPlaylist.classList.add('active-tab');
        btnNotes.classList.remove('active-tab');
        // If hidden class on container (tailwind), swap flex/hidden
        viewNotes.classList.remove('flex');
    } else {
        viewPlaylist.classList.add('hidden');
        viewNotes.classList.remove('hidden');
        viewNotes.classList.add('flex');
        btnPlaylist.classList.remove('active-tab');
        btnNotes.classList.add('active-tab');
    }
}

// --- Playlist Management ---
fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    // Add files to playlist
    files.forEach(f => playlist.push(f));
    
    updatePlaylistUI();
    
    // If no music is playing, start the first one added
    if (currentTrackIndex === -1) {
        loadTrack(0);
    }
    // Switch to playlist tab to show user
    switchTab('playlist');
});

function updatePlaylistUI() {
    queueCountEl.textContent = playlist.length;
    playlistContainer.innerHTML = '';

    if (playlist.length === 0) {
        playlistContainer.innerHTML = '<div class="text-center text-gray-500 text-sm mt-10 p-4">Cola vacÃ­a</div>';
        return;
    }

    playlist.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = `playlist-item p-2 rounded text-sm cursor-pointer hover:bg-gray-700 flex justify-between items-center group transition ${index === currentTrackIndex ? 'active' : 'text-gray-400'}`;
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'truncate font-mono pr-2';
        nameSpan.textContent = `${index + 1}. ${file.name}`;
        
        div.onclick = () => loadTrack(index);
        
        // Remove button
        const delBtn = document.createElement('button');
        delBtn.innerHTML = 'âœ•';
        delBtn.className = 'text-xs text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 px-2';
        delBtn.onclick = (e) => {
            e.stopPropagation();
            removeFromPlaylist(index);
        };

        div.appendChild(nameSpan);
        div.appendChild(delBtn);
        playlistContainer.appendChild(div);
    });
}

function removeFromPlaylist(index) {
    // If removing current track, stop it
    if (index === currentTrackIndex) {
        stopAudio();
        currentTrackIndex = -1;
        document.getElementById('file-name').textContent = "Cola vacÃ­a";
    }
    
    playlist.splice(index, 1);
    
    // Adjust index if we removed something before current
    if (index < currentTrackIndex) {
        currentTrackIndex--;
    }
    
    updatePlaylistUI();
}

async function loadTrack(index) {
    if (index < 0 || index >= playlist.length) return;
    
    initAudioContext();
    if(audioCtx.state === 'suspended') await audioCtx.resume();
    
    stopAudio(); // Clear previous
    currentTrackIndex = index;
    updatePlaylistUI(); // Highlight new active
    
    const file = playlist[index];
    document.getElementById('file-name').textContent = file.name;
    loadingOverlay.classList.remove('hidden');
    pausedAt = 0;

    const reader = new FileReader();
    reader.onload = async (ev) => {
        try {
            const arrayBuffer = ev.target.result;
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            
            // Reset Loop
            clearLoopPoints();
            
            totalTimeDisplay.textContent = formatTime(audioBuffer.duration);
            loadingOverlay.classList.add('hidden');
            
            drawStaticWaveform();
            playSound(); // Auto play on load
            
        } catch (err) {
            console.error(err);
            alert("Error al decodificar audio.");
            loadingOverlay.classList.add('hidden');
        }
    };
    reader.readAsArrayBuffer(file);
}

function playNext() {
    if (playlist.length === 0) return;
    let nextIndex = currentTrackIndex + 1;
    if (nextIndex >= playlist.length) nextIndex = 0; // Wrap around
    loadTrack(nextIndex);
}

function playPrev() {
    if (playlist.length === 0) return;
    let prevIndex = currentTrackIndex - 1;
    if (prevIndex < 0) prevIndex = playlist.length - 1; // Wrap around
    loadTrack(prevIndex);
}

// --- Audio Engine ---

function playSound() {
    if (!audioBuffer) return;

    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = audioBuffer;
    sourceNode.playbackRate.value = playbackRate;
    
    // Looping Logic
    if (isLooping || (markerAEl.style.display !== 'none' && markerBEl.style.display !== 'none')) {
        sourceNode.loop = true;
        if (markerAEl.style.display !== 'none' && markerBEl.style.display !== 'none') {
            sourceNode.loopStart = loopStart;
            sourceNode.loopEnd = loopEnd;
        } else if (isLooping) {
            sourceNode.loopStart = 0;
            sourceNode.loopEnd = audioBuffer.duration;
        }
    }

    gainNode = audioCtx.createGain();
    gainNode.gain.value = volume;
    analyserNode = audioCtx.createAnalyser();
    analyserNode.fftSize = 2048;

    sourceNode.connect(gainNode);
    gainNode.connect(analyserNode);
    analyserNode.connect(audioCtx.destination);

    // Playback Time
    if (sourceNode.loop && pausedAt >= sourceNode.loopEnd) pausedAt = sourceNode.loopStart;
    else if (pausedAt >= audioBuffer.duration) pausedAt = 0;

    playbackStartTime = audioCtx.currentTime - (pausedAt / playbackRate);
    sourceNode.start(0, pausedAt);
    
    // Auto Advance Logic
    sourceNode.onended = () => {
        // If ended naturally (not stopped by user or script manually)
        // AND not looping, go to next track
        if (isPlaying && !sourceNode.loop) {
            const timeDiff = Math.abs(getCurrentTime() - audioBuffer.duration);
            // Small tolerance because currentTime isn't perfectly precise at end
            if (timeDiff < 0.3) {
                // Track finished
                playNext();
                return;
            }
        }
    };

    isPlaying = true;
    updateTransportUI();
    animate();
}

function pauseAudio() {
    if (sourceNode) {
        pausedAt = getCurrentTime();
        try { sourceNode.stop(); } catch(e){}
        sourceNode = null;
    }
    isPlaying = false;
    cancelAnimationFrame(rafSpectrum);
    updateTransportUI();
    vuL.style.width = '0%'; vuR.style.width = '0%';
}

function stopAudio(resetTime = true) {
    if (sourceNode) {
        try { sourceNode.stop(); } catch(e){}
        sourceNode = null;
    }
    isPlaying = false;
    if (resetTime) { pausedAt = 0; updateCursor(0); }
    cancelAnimationFrame(rafSpectrum);
    updateTransportUI();
    ctxSpec.clearRect(0,0, canvasSpec.width, canvasSpec.height);
    vuL.style.width = '0%'; vuR.style.width = '0%';
}

function togglePlay() {
    if (!audioBuffer) return;
    if (isPlaying) pauseAudio();
    else playSound();
}

// --- Utils & Controls ---

function setSpeed(val) {
    playbackRate = parseFloat(val);
    document.getElementById('speed-val').textContent = playbackRate.toFixed(1) + 'x';
    if (sourceNode) {
        sourceNode.playbackRate.value = playbackRate;
        playbackStartTime = audioCtx.currentTime - (pausedAt / playbackRate);
    }
}

function setVolume(val) {
    volume = parseFloat(val);
    document.getElementById('vol-val').textContent = Math.round(volume * 100) + '%';
    if (gainNode) gainNode.gain.value = volume;
}

function getCurrentTime() {
    if (isScrubbing) return (parseFloat(scrubberSlider.value) / 1000) * audioBuffer.duration;
    if (!isPlaying) return pausedAt;
    
    let curr = (audioCtx.currentTime - playbackStartTime) * playbackRate;
    if (sourceNode && sourceNode.loop) {
        const dur = sourceNode.loopEnd - sourceNode.loopStart;
        if (curr >= sourceNode.loopEnd) {
             const offset = (curr - sourceNode.loopStart) % dur;
             curr = sourceNode.loopStart + offset;
        }
    }
    return Math.min(curr, audioBuffer.duration);
}

function skip(seconds) {
    if (!audioBuffer) return;
    let t = getCurrentTime() + seconds;
    seekTo(Math.max(0, Math.min(t, audioBuffer.duration)));
}

function seekTo(time) {
    if(!audioBuffer) return;
    const wasPlaying = isPlaying;
    if (isPlaying) pauseAudio();
    pausedAt = time;
    updateCursor(time);
    if (wasPlaying) playSound();
}

// --- Loop Logic ---
function toggleLoop() {
    isLooping = !isLooping;
    const btn = document.getElementById('btn-loop');
    btn.classList.toggle('text-cyan-400', isLooping);
    btn.classList.toggle('bg-gray-700', isLooping);
    if (isPlaying) { pauseAudio(); playSound(); }
}

function setLoopPoint(point) {
    if (!audioBuffer) return;
    const now = getCurrentTime();
    if (point === 'a') {
        loopStart = now;
        markerAEl.style.left = (loopStart / audioBuffer.duration * 100) + '%';
        markerAEl.style.display = 'block';
    } else {
        loopEnd = now;
        markerBEl.style.left = (loopEnd / audioBuffer.duration * 100) + '%';
        markerBEl.style.display = 'block';
    }
    if (isPlaying && markerAEl.style.display !== 'none' && markerBEl.style.display !== 'none') {
        pauseAudio(); playSound();
    }
}

function clearLoopPoints() {
    markerAEl.style.display = 'none';
    markerBEl.style.display = 'none';
    loopStart = 0; 
    if(audioBuffer) loopEnd = audioBuffer.duration;
    if(isPlaying && sourceNode && sourceNode.loop && !isLooping) {
        sourceNode.loop = false;
    } else if (isPlaying && isLooping) {
        pauseAudio(); playSound(); // Reset to full track loop
    }
}

// --- Visuals ---
function drawStaticWaveform() {
    if (!audioBuffer) return;
    const w = canvasWave.width, h = canvasWave.height;
    const data = audioBuffer.getChannelData(0);
    const step = Math.ceil(data.length / w);
    const amp = h / 2;
    ctxWave.clearRect(0, 0, w, h);
    ctxWave.fillStyle = '#06b6d4';
    ctxWave.beginPath();
    for (let i = 0; i < w; i++) {
        let min = 1.0, max = -1.0;
        for (let j = 0; j < step; j++) {
            const datum = data[(i * step) + j];
            if (datum < min) min = datum;
            if (datum > max) max = datum;
        }
        ctxWave.fillRect(i, (1 + min) * amp, 1, Math.max(1, (max - min) * amp));
    }
}

function drawSpectrum() {
    const w = canvasSpec.width, h = canvasSpec.height;
    const len = analyserNode.frequencyBinCount;
    const data = new Uint8Array(len);
    analyserNode.getByteFrequencyData(data);
    ctxSpec.clearRect(0, 0, w, h);
    const barW = (w / len) * 2.5;
    let x = 0;
    for (let i = 0; i < len; i++) {
        const barH = data[i] / 255 * h;
        ctxSpec.fillStyle = `hsl(${(i / len) * 360}, 80%, 50%)`;
        ctxSpec.fillRect(x, h - barH, barW, barH);
        x += barW + 1;
    }
}

function updateVUMeter() {
    const arr = new Uint8Array(analyserNode.frequencyBinCount);
    analyserNode.getByteTimeDomainData(arr);
    let sum = 0;
    for(let i=0; i<arr.length; i++) {
        const x = (arr[i]-128)/128;
        sum += x*x;
    }
    const rms = Math.sqrt(sum/arr.length);
    const pct = Math.min(100, rms * 400);
    vuL.style.width = pct + '%'; vuR.style.width = pct + '%';
}

function animate() {
    if (!isPlaying && !isScrubbing) return;
    const curr = getCurrentTime();
    timeDisplay.textContent = formatTime(curr);
    
    if (!isScrubbing && audioBuffer) {
        scrubberSlider.value = (curr / audioBuffer.duration) * 1000;
        cursorEl.style.left = (curr / audioBuffer.duration * 100) + '%';
    }

    if (isPlaying) {
        drawSpectrum();
        updateVUMeter();
    }
    rafSpectrum = requestAnimationFrame(animate);
}

function updateCursor(time) {
    if (!audioBuffer) return;
    timeDisplay.textContent = formatTime(time);
    cursorEl.style.left = (time / audioBuffer.duration * 100) + '%';
    scrubberSlider.value = (time / audioBuffer.duration) * 1000;
}

function formatTime(s) {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = Math.floor(s % 60);
    const ms = Math.floor((s % 1) * 10);
    return (h>0?h+':':'') + `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms}`;
}

function updateTransportUI() {
    document.getElementById('icon-play').classList.toggle('hidden', isPlaying);
    document.getElementById('icon-pause').classList.toggle('hidden', !isPlaying);
}

// --- Events ---
scrubberSlider.addEventListener('input', (e) => {
    if (!audioBuffer) return;
    isScrubbing = true;
    const time = (e.target.value / 1000) * audioBuffer.duration;
    timeDisplay.textContent = formatTime(time);
    cursorEl.style.left = (time/audioBuffer.duration*100)+'%';
});
scrubberSlider.addEventListener('change', (e) => {
    if (!audioBuffer) return;
    isScrubbing = false;
    seekTo((e.target.value / 1000) * audioBuffer.duration);
});

// Shortcuts
function toggleShortcuts() { document.getElementById('shortcuts-modal').classList.toggle('hidden'); }
window.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.altKey) {
        e.preventDefault();
        switch(e.code) {
            case 'KeyP': togglePlay(); break;
            case 'KeyS': stopAudio(); break;
            case 'KeyL': toggleLoop(); break;
            case 'KeyA': setLoopPoint('a'); break;
            case 'KeyB': 
                if (e.shiftKey) setLoopPoint('b'); // Shift+B for Loop
                else playPrev(); // Just B for Back
                break;
            case 'KeyN': playNext(); break;
            case 'ArrowLeft': e.shiftKey ? skip(-10) : skip(-5); break;
            case 'ArrowRight': e.shiftKey ? skip(10) : skip(5); break;
            case 'ArrowUp': 
                setVolume(Math.min(10, volume + 0.1)); 
                document.getElementById('vol-slider').value = volume; break;
            case 'ArrowDown': 
                setVolume(Math.max(0, volume - 0.1)); 
                document.getElementById('vol-slider').value = volume; break;
            case 'Minus': case 'NumpadSubtract':
                setSpeed(Math.max(0.5, playbackRate - 0.1));
                document.querySelector('input[type=range][min="0.5"]').value = playbackRate; break;
            case 'Equal': case 'NumpadAdd':
                setSpeed(Math.min(2.0, playbackRate + 0.1));
                document.querySelector('input[type=range][min="0.5"]').value = playbackRate; break;
            case 'KeyH': toggleShortcuts(); break;
        }
    }
});

// Notes
const notesArea = document.getElementById('notes-area');
function loadNotes() { notesArea.value = localStorage.getItem('audio_notes') || ''; }
notesArea.addEventListener('input', () => localStorage.setItem('audio_notes', notesArea.value));
function insertTimestamp() {
    const t = formatTime(getCurrentTime());
    const p = notesArea.selectionStart;
    notesArea.value = notesArea.value.slice(0,p) + `[${t}] ` + notesArea.value.slice(p);
    notesArea.focus();
    localStorage.setItem('audio_notes', notesArea.value);
}
function downloadNotes() {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([notesArea.value], {type:'text/markdown'}));
    a.download = 'notas_audio.md';
    a.click();
}
</script>
</body>
</html>