<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piano Touch Pro – Optimizado</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Elimina flash azul en móvil */
        }

        body {
            margin: 0;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0b0b10 100%);
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #top {
            padding: 10px 16px;
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid #333;
            z-index: 10;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #222;
            padding: 4px 10px;
            border-radius: 12px;
        }

        button {
            background: #333;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.1s;
            will-change: transform;
        }

        button:active {
            transform: scale(0.95);
            background: #444;
        }

        #octave {
            min-width: 20px;
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
        }

        #piano {
            flex: 1;
            display: flex;
            padding: 10px 5px;
            touch-action: none; /* Crucial para evitar scroll/zoom e interferencia */
            background: #000;
            position: relative;
        }

        .key {
            flex: 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 15px;
            position: relative;
            border-radius: 0 0 6px 6px;
            transition: background 0.05s;
            will-change: transform, background;
        }

        .white {
            background: linear-gradient(to bottom, #eee 0%, #fff 100%);
            color: #333;
            margin: 1px;
            z-index: 1;
        }

        .white.active {
            background: #ddd;
            transform: translateY(2px);
        }

        .black {
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            color: white;
            margin-left: -2%;
            margin-right: -2%;
            z-index: 2;
            flex: 0.65;
            height: 60%;
            border: 1px solid #000;
        }

        .black.active {
            background: #444;
            transform: translateY(2px);
        }

        .key span {
            font-size: 10px;
            pointer-events: none;
            text-transform: uppercase;
            font-weight: bold;
            opacity: 0.5;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: flex-end;
        }

        input[type=range] {
            width: 100px;
        }

        @media (max-width: 600px) {
            #top { flex-wrap: wrap; justify-content: center; }
            .volume-control { min-width: 100%; justify-content: center; margin-top: 5px; }
        }
    </style>
</head>
<body>

<div id="top">
    <div class="control-group">
        <button id="down">◀</button>
        <span>Oct: <span id="octave">3</span></span>
        <button id="up">▶</button>
    </div>
    
    <button id="wave">SAWTOOTH</button>

    <div class="volume-control">
        <span>Vol</span>
        <input type="range" id="volume" min="0" max="100" value="30">
    </div>
</div>

<div id="piano"></div>

<script>
'use strict';

const config = {
    waveTypes: ['sawtooth', 'sine', 'square', 'triangle'],
    attack: 0.005, // Más rápido para evitar delay percibido
    release: 0.1
};

const state = {
    baseOctave: 3,
    waveIdx: 0,
    vol: 0.3,
    activeNotes: new Map()
};

// Audio Setup - Singleton para eficiencia
let audioCtx = null;
const getCtx = () => {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({
            latencyHint: 'interactive' // Optimiza para baja latencia
        });
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
};

const notes = [
    { n: 'C', f: 0 }, { n: 'C#', f: 1 }, { n: 'D', f: 2 }, { n: 'D#', f: 3 },
    { n: 'E', f: 4 }, { n: 'F', f: 5 }, { n: 'F#', f: 6 }, { n: 'G', f: 7 },
    { n: 'G#', f: 8 }, { n: 'A', f: 9 }, { n: 'A#', f: 10 }, { n: 'B', f: 11 }
];

const midiToFreq = m => 440 * Math.pow(2, (m - 69) / 12);

class Voice {
    constructor(midi) {
        const ctx = getCtx();
        this.osc = ctx.createOscillator();
        this.gain = ctx.createGain();
        
        this.osc.type = config.waveTypes[state.waveIdx];
        this.osc.frequency.setValueAtTime(midiToFreq(midi), ctx.currentTime);
        
        this.gain.gain.setValueAtTime(0, ctx.currentTime);
        this.gain.gain.linearRampToValueAtTime(state.vol, ctx.currentTime + config.attack);
        
        this.osc.connect(this.gain).connect(ctx.destination);
        this.osc.start();
    }
    
    stop() {
        const ctx = getCtx();
        const end = ctx.currentTime + config.release;
        this.gain.gain.cancelScheduledValues(ctx.currentTime);
        this.gain.gain.setValueAtTime(this.gain.gain.value, ctx.currentTime);
        this.gain.gain.exponentialRampToValueAtTime(0.001, end);
        this.osc.stop(end);
    }
}

const piano = document.getElementById('piano');

function build() {
    let html = '';
    for (let o = 0; o < 2; o++) {
        notes.forEach(note => {
            const isBlack = note.n.includes('#');
            const midi = (state.baseOctave + o) * 12 + note.f;
            html += `<div class="key ${isBlack ? 'black' : 'white'}" data-midi="${midi}">
                        <span>${note.n}${state.baseOctave + o}</span>
                     </div>`;
        });
    }
    piano.innerHTML = html;
}

// OPTIMIZACIÓN: Event Delegation
// En lugar de un listener por tecla, usamos uno para todo el piano.
const handleInteraction = (e, isStart) => {
    e.preventDefault();
    const target = e.target.closest('.key');
    if (!target) return;
    
    const midi = target.dataset.midi;
    
    if (isStart) {
        if (!state.activeNotes.has(midi)) {
            target.classList.add('active');
            state.activeNotes.set(midi, new Voice(midi));
        }
    } else {
        const voice = state.activeNotes.get(midi);
        if (voice) {
            voice.stop();
            state.activeNotes.delete(midi);
            target.classList.remove('active');
        }
    }
};

// Listeners de piano optimizados
piano.addEventListener('touchstart', e => handleInteraction(e, true), {passive: false});
piano.addEventListener('touchend', e => handleInteraction(e, false), {passive: false});
piano.addEventListener('touchcancel', e => handleInteraction(e, false), {passive: false});
piano.addEventListener('mousedown', e => handleInteraction(e, true));
window.addEventListener('mouseup', e => {
    // Limpiar todas si el mouse se levanta fuera del piano
    state.activeNotes.forEach((v, k) => {
        v.stop();
        document.querySelector(`[data-midi="${k}"]`)?.classList.remove('active');
    });
    state.activeNotes.clear();
});

// Controles secundarios
document.getElementById('down').onclick = () => { if(state.baseOctave > 0) { state.baseOctave--; updateUI(); } };
document.getElementById('up').onclick = () => { if(state.baseOctave < 7) { state.baseOctave++; updateUI(); } };
document.getElementById('wave').onclick = (e) => {
    state.waveIdx = (state.waveIdx + 1) % config.waveTypes.length;
    e.target.innerText = config.waveTypes[state.waveIdx].toUpperCase();
};
document.getElementById('volume').oninput = (e) => { state.vol = e.target.value / 100; };

function updateUI() {
    document.getElementById('octave').innerText = state.baseOctave;
    build();
}

// Inicializar
build();
</script>
</body>
</html>
